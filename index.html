<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠ - Edir Digital Pro</title>
    <!-- SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@100..900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Telegram Theme Adaptive Colors */
            --tg-bg: var(--tg-theme-bg-color, #f8fafc);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #0f172a);
            --tg-hint: var(--tg-theme-hint-color, #64748b);
            --tg-link: var(--tg-theme-link-color, #15803d);
            --brand-green: #15803d;
            --brand-light: rgba(21, 128, 61, 0.08);
            --card-border: rgba(226, 232, 240, 0.8);
        }

        @media (prefers-color-scheme: dark) {
            :root { --card-border: rgba(51, 65, 85, 0.5); }
        }

        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: 'Noto Sans Ethiopic', 'Inter', sans-serif;
            margin: 0; padding: 0; overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease;
        }

        .glass-header {
            background: rgba(var(--tg-theme-bg-color-rgb, 255, 255, 255), 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
        }

        .nav-container {
            background-color: var(--brand-green);
            box-shadow: 0 10px 25px -5px rgba(21, 128, 61, 0.4);
            border-radius: 1.5rem;
            padding: 5px;
        }

        .nav-btn {
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 800;
            font-size: 11px;
            border-radius: 1.1rem;
            text-transform: uppercase;
        }

        .active-tab {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .section-card {
            background-color: var(--tg-secondary-bg);
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .method-card {
            border: 2px solid var(--card-border);
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--tg-secondary-bg);
        }

        .method-card.selected {
            background-color: var(--brand-green) !important;
            border-color: var(--brand-green);
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -5px rgba(21, 128, 61, 0.3);
        }

        .gateway-pill {
            border: 2px solid var(--card-border);
            transition: all 0.2s ease;
            cursor: pointer;
            filter: grayscale(1);
            opacity: 0.6;
            background-color: var(--tg-bg);
        }

        .gateway-pill.selected {
            border-color: var(--brand-green);
            background-color: var(--brand-light);
            filter: grayscale(0);
            opacity: 1;
            transform: scale(1.05);
        }

        .input-style {
            background-color: var(--tg-bg);
            border: 2px solid var(--card-border);
            border-radius: 1rem;
            padding: 0.875rem 1rem;
            width: 100%;
            font-size: 15px;
            color: var(--tg-text);
            transition: all 0.2s;
        }

        .input-style:disabled {
            opacity: 0.7;
            background-color: rgba(0,0,0,0.03);
            cursor: not-allowed;
        }

        .verified-badge { background: linear-gradient(135deg, #22c55e 0%, #15803d 100%); }
        .status-pill { background-color: var(--tg-bg); border: 1px solid var(--card-border); }
        .animate-section { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .loader {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 18px; height: 18px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="select-none">

    <header class="glass-header sticky top-0 z-50 px-5 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="logo.jpg" class="w-11 h-11 rounded-2xl shadow-lg border-2 border-white/10 object-cover" onerror="this.style.display='none'">
            <div>
                <h1 class="text-sm font-black uppercase tracking-tight leading-none">·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠</h1>
                <div class="flex items-center gap-1.5 mt-1.5">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                    <p class="text-[9px] text-green-600 font-extrabold uppercase">·à≤·àµ·â∞·àô ·ä≠·çç·âµ ·äê·ãç</p>
                </div>
            </div>
        </div>
        <div class="text-right">
            <span id="userName" class="text-xs font-black block truncate max-w-[110px]">·ä†·â£·àç</span>
            <span id="memberId" class="text-[8px] font-bold opacity-50 uppercase tracking-widest">ID: #---</span>
        </div>
    </header>

    <main class="max-w-md mx-auto p-5 pb-24">
        <nav class="nav-container grid grid-cols-4 mb-8">
            <button onclick="showTab('payment')" id="paymentTab" class="nav-btn py-3.5 active-tab">·ä≠·çç·ã´</button>
            <button onclick="showTab('status')" id="statusTab" class="nav-btn py-3.5">·àÅ·äî·â≥</button>
            <button onclick="showTab('loan')" id="loanTab" class="nav-btn py-3.5">·â•·ãµ·à≠</button>
            <button onclick="showTab('help')" id="helpTab" class="nav-btn py-3.5">·ä•·à≠·ã≥·â≥</button>
        </nav>

        <!-- 1. Payment Section -->
        <section id="paymentSection" class="animate-section space-y-7">
            <div class="space-y-4">
                <h3 class="text-[10px] font-black uppercase opacity-50 tracking-[0.2em] ml-1">·ã®·ä≠·çç·ã´ ·àù·à≠·å´</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div id="manualBtn" class="method-card p-6 rounded-[2rem] flex flex-col items-center gap-3 selected" onclick="selectPaymentMode('manual')">
                        <span class="text-3xl">üßæ</span>
                        <span class="text-[10px] font-black uppercase tracking-wider">·â†·ã∞·à®·à∞·äù</span>
                    </div>
                    <div id="easypayBtn" class="method-card p-6 rounded-[2rem] flex flex-col items-center gap-3" onclick="selectPaymentMode('easypay')">
                        <span class="text-3xl">üí≥</span>
                        <span class="text-[10px] font-black uppercase tracking-wider">·âÄ·àã·àç ·ä≠·çç·ã´</span>
                    </div>
                </div>
            </div>

            <!-- Gateway Selector for Digital -->
            <div id="gatewaySelector" class="hidden section-card p-5 space-y-4">
                <h3 class="text-[10px] font-black uppercase opacity-40 text-center tracking-widest">·àò·â∞·åç·â†·à™·ã´ ·ã≠·àù·à®·å°</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div class="gateway-pill p-3 rounded-2xl flex flex-col items-center selected" onclick="selectGateway('chapa', this)">
                        <img src="Chapa.png" class="w-10 h-10 mb-1 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=C&background=000&color=fff'">
                        <span class="text-[8px] font-black uppercase">Chapa</span>
                    </div>
                    <div class="gateway-pill p-3 rounded-2xl flex flex-col items-center" onclick="selectGateway('telebirr', this)">
                        <img src="Telebirr.png" class="w-10 h-10 mb-1 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=T&background=0052cc&color=fff'">
                        <span class="text-[8px] font-black uppercase">Telebirr</span>
                    </div>
                    <div class="gateway-pill p-3 rounded-2xl flex flex-col items-center" onclick="selectGateway('cbe', this)">
                        <img src="Cbe.png" class="w-10 h-10 mb-1 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=E&background=6a1b9a&color=fff'">
                        <span class="text-[8px] font-black uppercase">CBE Birr</span>
                    </div>
                    <div class="gateway-pill p-3 rounded-2xl flex flex-col items-center" onclick="selectGateway('arifpay', this)">
                        <img src="ArifPay.png" class="w-10 h-10 mb-1 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=A&background=ff6d00&color=fff'">
                        <span class="text-[8px] font-black uppercase">ArifPay</span>
                    </div>
                    <div class="gateway-pill p-3 rounded-2xl flex flex-col items-center" onclick="selectGateway('mpesa', this)">
                        <img src="Safaricom.png" class="w-10 h-10 mb-1 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=S&background=c62828&color=fff'">
                        <span class="text-[8px] font-black uppercase">M-Pesa</span>
                    </div>
                    <div class="gateway-pill p-3 rounded-2xl flex flex-col items-center" onclick="selectGateway('starpay', this)">
                        <img src="StarPay.png" class="w-10 h-10 mb-1 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=St&background=1a237e&color=fff'">
                        <span class="text-[8px] font-black uppercase">StarPay</span>
                    </div>
                </div>
            </div>

            <form id="paymentForm" class="space-y-6">
                <div class="section-card p-6 space-y-6">
                    <div class="space-y-2">
                        <label class="text-[9px] font-black uppercase opacity-40 ml-1">·ã®·ä≠·çç·ã´ ·ãì·ã≠·äê·âµ</label>
                        <select id="paymentType" class="input-style font-black text-sm" onchange="updatePenalty()">
                            <option value="·àò·ã∞·â†·äõ ·àò·ãã·åÆ">·àò·ã∞·â†·äõ ·àò·ãã·åÆ</option>
                            <option value="·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª">·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª</option>
                            <option value="·ã®·âÖ·å£·âµ ·ä≠·çç·ã´">·ã®·âÖ·å£·âµ ·ä≠·çç·ã´</option>
                            <option value="·àå·àã">·àå·àã</option>
                        </select>
                    </div>

                    <div id="dateSelectorRow" class="space-y-2">
                        <label class="text-[9px] font-black uppercase opacity-40 ml-1">·ã®·ä≠·çç·ã´ ·âÄ·äï (·ãõ·à¨ - ·ã®·àõ·ã≠·âÄ·ã®·à≠)</label>
                        <div class="grid grid-cols-3 gap-2">
                            <select id="month" disabled class="input-style font-black text-[11px] px-2 bg-slate-100 border-none">
                                <option value="·àò·àµ·ä®·à®·àù">·àò·àµ·ä®·à®·àù</option><option value="·å•·âÖ·àù·âµ">·å•·âÖ·àù·âµ</option><option value="·àÖ·ã≥·à≠">·àÖ·ã≥·à≠</option>
                                <option value="·â≥·àÖ·à≥·àµ">·â≥·àÖ·à≥·àµ</option><option value="·å•·à≠">·å•·à≠</option><option value="·ã®·ä´·â≤·âµ">·ã®·ä´·â≤·âµ</option>
                                <option value="·àò·åã·â¢·âµ">·àò·åã·â¢·âµ</option><option value="·àö·ã´·ãù·ã´">·àö·ã´·ãù·ã´</option><option value="·åç·äï·â¶·âµ">·åç·äï·â¶·âµ</option>
                                <option value="·à∞·äî">·à∞·äî</option><option value="·àê·àù·àå">·àê·àù·àå</option><option value="·äê·àê·à¥">·äê·àê·à¥</option>
                                <option value="·å≥·åâ·àú">·å≥·åâ·àú</option>
                            </select>
                            <select id="day" disabled class="input-style font-black text-[11px] px-2 bg-slate-100 border-none">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                                <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                                <option value="13">13</option><option value="14">14</option><option value="15">15</option>
                                <option value="16">16</option><option value="17">17</option><option value="18">18</option>
                                <option value="19">19</option><option value="20">20</option><option value="21">21</option>
                                <option value="22">22</option><option value="23">23</option><option value="24">24</option>
                                <option value="25">25</option><option value="26">26</option><option value="27">27</option>
                                <option value="28">28</option><option value="29">29</option><option value="30">30</option>
                            </select>
                            <select id="year" disabled class="input-style font-black text-[11px] px-2 bg-slate-100 border-none">
                                <option value="2017">2017</option><option value="2018">2018</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-[9px] font-black uppercase opacity-40 ml-1">·àò·å†·äï (Amount)</label>
                            <input type="number" id="amount" placeholder="0.00" required class="input-style font-black text-green-700">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] font-black uppercase opacity-40 ml-1">·âÖ·å£·âµ (Penalty)</label>
                            <input type="number" id="penalty" value="0" readonly class="input-style font-black text-red-600 bg-slate-50">
                        </div>
                    </div>
                </div>

                <div id="receiptWrapper" class="section-card p-6 space-y-4">
                    <label class="text-[9px] font-black uppercase opacity-40 ml-1">·ã®·ã∞·à®·à∞·äù ·çé·â∂ (Receipt)</label>
                    <div class="relative w-full aspect-video bg-black/5 rounded-3xl border-2 border-dashed border-black/10 flex flex-col items-center justify-center overflow-hidden transition-all hover:bg-black/10" onclick="document.getElementById('receiptInput').click()">
                        <div id="uploadPlaceholder" class="text-center">
                            <span class="text-3xl block mb-2">üì∏</span>
                            <span class="text-[10px] font-black opacity-40 uppercase tracking-widest">·àà·àò·å´·äï ·ã≠·äï·ä©</span>
                        </div>
                        <input type="file" id="receiptInput" accept="image/*" class="hidden" onchange="handlePreview(this)">
                        <img id="receiptPreview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                </div>

                <button type="submit" id="submitBtn" class="w-full py-5 bg-green-700 text-white rounded-[1.75rem] font-black text-xl shadow-2xl shadow-green-900/20 flex items-center justify-center gap-4 active:scale-95 transition-all">
                    <span id="btnText">·àò·à®·åÉ·ãç·äï ·àã·ä≠</span>
                </button>
            </form>
        </section>

        <!-- 2. Status Section -->
        <section id="statusSection" class="hidden animate-section space-y-7">
            <div class="bg-slate-900 p-10 rounded-[2.5rem] shadow-2xl relative overflow-hidden text-white">
                <div class="absolute -right-10 -top-10 w-44 h-44 bg-green-500/10 rounded-full blur-3xl"></div>
                <div class="space-y-1">
                    <p class="text-[10px] font-black uppercase tracking-[0.3em] opacity-40">·å†·âÖ·àã·àã ·ã®·â∞·ä®·çà·àà ·àÇ·à≥·â•</p>
                    <h2 class="text-5xl font-black tracking-tight"><span id="totalBalance">0.00</span> <span class="text-xs opacity-40 font-bold ml-1">ETB</span></h2>
                </div>
                <div class="mt-8 bg-white/5 p-5 rounded-[1.5rem] border border-white/10 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-black uppercase opacity-50 mb-1">·ã®·âÄ·à® ·ãï·ã≥ (Remaining)</p>
                        <h3 class="text-2xl font-black text-red-400"><span id="remainingBalance">0.00</span> ETB</h3>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-black uppercase opacity-40">·àÅ·äî·â≥</p>
                        <p id="memberStatus" class="text-xs font-black uppercase text-green-400">·ã´·àç·â≥·ãà·âÄ</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-5">
                <div class="section-card p-6 flex flex-col items-center">
                    <span class="text-2xl block mb-3">üìÖ</span>
                    <p class="text-[9px] font-black opacity-40 uppercase tracking-widest mb-1 text-center">·àò·ã∞·â†·äõ ·àò·ãã·åÆ</p>
                    <p class="text-xl font-black"><span id="sumMonthly">0.00</span> <span class="text-[9px] opacity-30">ETB</span></p>
                </div>
                <div class="section-card p-6 flex flex-col items-center">
                    <span class="text-2xl block mb-3">‚ö†Ô∏è</span>
                    <p class="text-[9px] font-black opacity-40 uppercase tracking-widest mb-1 text-center">·ã®·âÖ·å£·âµ ·ä≠·çç·ã´</p>
                    <p class="text-xl font-black text-red-600"><span id="sumPenalty">0.00</span> <span class="text-[9px] opacity-30">ETB</span></p>
                </div>
            </div>

            <div id="pendingAlert" class="hidden bg-orange-500/10 border border-orange-500/20 p-5 rounded-[2rem] flex items-start gap-4 animate-pulse">
                <div class="w-12 h-12 bg-orange-500 rounded-2xl flex items-center justify-center text-white shadow-xl flex-shrink-0">üîî</div>
                <div>
                    <h5 class="text-[10px] font-black text-orange-700 uppercase tracking-wider">·àõ·à®·åã·åà·å´ ·â†·àò·å†·â£·â†·âÖ ·àã·ã≠</h5>
                    <p class="text-[9px] font-bold text-orange-600/80 mt-1">·ã®·àã·ä©·âµ ·ä≠·çç·ã´ ·â†·ä†·àµ·â∞·ã≥·ã≥·à™·ãç ·ä•·äï·ã≤·à®·åã·åà·å• ·ä•·ã®·â∞·ã∞·à®·åà ·äê·ãç·ç¢</p>
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="text-[10px] font-black uppercase opacity-40 tracking-[0.3em] px-2">·ã®·âÖ·à≠·â• ·åä·ãú ·ä•·äï·âÖ·àµ·âÉ·à¥·ãé·âΩ</h4>
                <div id="transactionList" class="space-y-3 text-center py-5">
                    <div class="opacity-20 text-xs font-black uppercase tracking-widest">·àù·äï·àù ·ä•·äï·âÖ·àµ·âÉ·à¥ ·ã®·àà·àù</div>
                </div>
            </div>
        </section>

        <!-- 3. Loan Section -->
        <section id="loanSection" class="hidden animate-section space-y-6">
            <div class="section-card p-8 text-center bg-slate-50 border-dashed border-2">
                <div class="w-20 h-20 bg-brand-green/10 rounded-full flex items-center justify-center text-4xl mx-auto mb-4">üè¶</div>
                <h3 class="text-xl font-black uppercase text-slate-800 tracking-tight">·ã®·â•·ãµ·à≠ ·ä†·åà·àç·åç·àé·âµ</h3>
                <p class="text-[11px] font-bold text-slate-500 mt-2 leading-relaxed">·ã®·ã≤·åÇ·â≥·àç ·â•·ãµ·à≠ ·ä†·åà·àç·åç·àé·âµ ·â†·âÖ·à≠·â° ·ã≠·åÄ·àù·à´·àç·ç¢ ·ä†·â£·àã·âµ ·ã´·àâ·â£·â∏·ãç·äï ·àò·ãã·åÆ·ãé·âΩ ·â†·àõ·å†·äì·âÄ·âÖ ·àà·â•·ãµ·à≠ ·ãù·åç·åÅ ·àò·àÜ·äï ·ã≠·âΩ·àã·àâ·ç¢</p>
                <div class="mt-6 py-2 px-5 bg-slate-200 rounded-full inline-block text-[10px] font-black uppercase text-slate-600 animate-pulse">
                    üöß ·â†·åç·äï·â£·â≥ ·àã·ã≠
                </div>
            </div>
        </section>

        <!-- 4. Help Section -->
        <section id="helpSection" class="hidden animate-section py-5 space-y-6">
            <div class="section-card p-6 space-y-4">
                <h4 class="text-sm font-black uppercase border-b border-black/5 pb-3 tracking-widest">·àò·àò·à™·ã´·ãé·âΩ</h4>
                <div class="space-y-4 text-xs font-semibold text-slate-600 leading-relaxed">
                    <div class="flex gap-3">
                        <span class="text-brand-green font-black">1.</span>
                        <p>·ä≠·çç·ã´ ·â†·ã∞·à®·à∞·äù ·à≤·çà·åΩ·àô ·ã®·ã∞·à®·à∞·äô·äï ·çé·â∂ ·â†·âµ·ä≠·ä≠·àç ·àò·å´·äï·ãé·äï ·ã´·à®·åã·åç·å°·ç¢</p>
                    </div>
                    <div class="flex gap-3">
                        <span class="text-brand-green font-black">2.</span>
                        <p>·ã®·ã≤·åÇ·â≥·àç ·ä≠·çç·ã´ (EasyPay) ·à≤·å†·âÄ·àô ·ä≠·çç·ã´·ãç ·â†·âÄ·å•·â≥ ·àà·â¶·â± ·ã≠·àã·ä´·àç·ç¢</p>
                    </div>
                </div>
            </div>
            <a href="https://t.me/Abiym" target="_blank" class="block bg-blue-600/10 border border-blue-600/20 p-6 rounded-[2rem] flex items-center justify-between group active:scale-95 transition-all">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-xl">üí¨</div>
                    <div>
                        <h4 class="text-xs font-black text-blue-900 uppercase tracking-tight">·ä•·à≠·ã≥·â≥ ·ã≠·çà·àç·åã·àâ?</h4>
                        <p class="text-[10px] font-bold text-blue-700/60">·ä†·àµ·â∞·ã≥·ã≥·à™·ãç·äï ·ã´·äê·åã·åç·à©</p>
                    </div>
                </div>
                <span class="text-blue-600 group-hover:translate-x-2 transition-transform font-black">‚Üí</span>
            </a>
        </section>

        <footer class="mt-12 text-center opacity-10">
            <p class="text-[9px] font-black uppercase tracking-[0.4em]">Edir Digital v3.6 ‚Ä¢ SkyMark</p>
        </footer>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State - Set to window for HTML accessibility
        window.paymentMode = 'manual';
        window.selectedGateway = 'chapa';
        window.currentUser = null;
        const MONTHLY_FEE = 100;

        // UI Logic attached to Window
        window.showTab = (t) => {
            ['payment', 'status', 'loan', 'help'].forEach(s => {
                const sec = document.getElementById(s+'Section');
                const btn = document.getElementById(s+'Tab');
                if(sec) sec.classList.add('hidden');
                if(btn) btn.classList.remove('active-tab');
            });
            const activeSec = document.getElementById(t+'Section');
            const activeTab = document.getElementById(t+'Tab');
            if(activeSec) activeSec.classList.remove('hidden');
            if(activeTab) activeTab.classList.add('active-tab');
            
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.selectPaymentMode = (mode) => {
            window.paymentMode = mode;
            document.getElementById('manualBtn').classList.toggle('selected', mode === 'manual');
            document.getElementById('easypayBtn').classList.toggle('selected', mode === 'easypay');
            document.getElementById('gatewaySelector').classList.toggle('hidden', mode === 'manual');
            document.getElementById('receiptWrapper').classList.toggle('hidden', mode === 'easypay');
            document.getElementById('btnText').innerText = mode === 'manual' ? '·àò·à®·åÉ·ãç·äï ·àã·ä≠' : '·àà·àò·ä≠·çà·àç ·âÄ·å•·àç';
            
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.selectionChanged();
            }
        };

        window.selectGateway = (gateway, el) => {
            window.selectedGateway = gateway;
            document.querySelectorAll('.gateway-pill').forEach(p => p.classList.remove('selected'));
            el.classList.add('selected');
            
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.selectionChanged();
            }
        };

        window.updatePenalty = () => {
            const dayEl = document.getElementById('day');
            const typeEl = document.getElementById('paymentType');
            const penaltyInput = document.getElementById('penalty');
            if (!dayEl || !typeEl || !penaltyInput) return;

            const day = parseInt(dayEl.value);
            const type = typeEl.value;
            
            if (type === '·àò·ã∞·â†·äõ ·àò·ãã·åÆ') {
                if (day >= 1 && day <= 5) penaltyInput.value = 0;
                else if (day >= 6 && day <= 10) penaltyInput.value = 20;
                else if (day >= 11) penaltyInput.value = 50;
            } else {
                penaltyInput.value = 0;
            }
        };

        // Firebase Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'edir-digital-v3';

        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                setupDataListeners(user.uid);
                const u = tg.initDataUnsafe?.user;
                if (u) {
                    const nameStr = [u.first_name, u.last_name].filter(Boolean).join(' ');
                    const nameEl = document.getElementById('userName');
                    if (nameEl) nameEl.innerText = nameStr || "·ä†·â£·àç";
                }
                setEthiopianDate();
                window.updatePenalty();
            }
        });

        initAuth();

        function setEthiopianDate() {
            const monthEl = document.getElementById('month');
            const dayEl = document.getElementById('day');
            const yearEl = document.getElementById('year');
            if (monthEl && dayEl && yearEl) {
                monthEl.value = "·ã®·ä´·â≤·âµ"; 
                dayEl.value = "17"; 
                yearEl.value = "2018";
            }
        }

        async function initDigitalPayment(amount, purpose) {
            if (!window.currentUser) {
                tg.showPopup({ message: "·ä•·â£·ä≠·ãé ·àò·åÄ·àò·à™·ã´ ·â†·â¥·àå·åç·à´·àù ·ã≠·åç·â°" });
                return;
            }

            if (tg.MainButton) {
                tg.MainButton.setText(`·ä≠·çç·ã´ ·â†${(window.selectedGateway || 'Gateway').toUpperCase()} ·â†·àò·åÄ·àò·à≠ ·àã·ã≠...`);
                tg.MainButton.show();
                tg.MainButton.showProgress();
            }

            const txRef = `TX-${Date.now()}-${window.currentUser.uid.slice(-4)}`;
            const payload = { 
                type: 'payment_report', 
                gateway: window.selectedGateway, 
                purpose: purpose, 
                totalAmount: amount, 
                isDigital: true, 
                tx_ref: txRef 
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'payments'), {
                    ...payload,
                    status: 'AWAIT_APPROVAL',
                    timestamp: serverTimestamp()
                });
                tg.sendData(JSON.stringify(payload));
                
                setTimeout(() => {
                    if (tg.MainButton) {
                        tg.MainButton.hideProgress();
                        tg.MainButton.setText("·ä≠·çç·ã´·ãç ·â∞·àò·ãù·åç·âß·àç ‚úÖ");
                    }
                    setTimeout(() => tg.close(), 1500);
                }, 1500);
            } catch (err) {
                if (tg.MainButton) {
                    tg.MainButton.hideProgress();
                    tg.MainButton.setText("·àµ·àÖ·â∞·âµ ·â∞·çà·å•·àØ·àç ‚ùå");
                }
            }
        }

        function setupDataListeners(uid) {
            onSnapshot(doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data'), (ds) => {
                const statusEl = document.getElementById('memberStatus');
                if (ds.exists() && statusEl) {
                    statusEl.innerText = ds.data().isVerified ? '·ã®·â∞·à®·åã·åà·å† ·ä†·â£·àç' : '·ã´·àç·â∞·à®·åã·åà·å†';
                }
            });

            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'payments'), (snap) => {
                const list = document.getElementById('transactionList');
                if (!list) return;

                if (snap.empty) {
                    list.innerHTML = '<div class="opacity-20 text-xs font-black uppercase tracking-widest">·àù·äï·àù ·ä•·äï·âÖ·àµ·âÉ·à¥ ·ã®·àà·àù</div>';
                    const remEl = document.getElementById('remainingBalance');
                    if (remEl) remEl.innerText = (6 * MONTHLY_FEE).toLocaleString();
                    return;
                }

                let h = '', m = 0, p = 0, t = 0, pend = false;
                const sortedDocs = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                           .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                sortedDocs.forEach(tx => {
                    const status = tx.status || 'AWAIT_APPROVAL';
                    if (status === 'AWAIT_APPROVAL') pend = true;
                    if (status === 'APPROVED') {
                        t += (tx.totalAmount || 0);
                        if (tx.purpose && tx.purpose.includes('·àò·ãã·åÆ')) m += (tx.baseAmount || tx.totalAmount || 0);
                        p += (tx.penaltyAmount || 0);
                    }

                    const clr = status === 'APPROVED' ? 'text-green-600 bg-green-50' : (status === 'REJECTED' ? 'text-red-600 bg-red-50' : 'text-orange-600 bg-orange-50');
                    const icon = (tx.purpose && tx.purpose.includes('·àò·ãã·åÆ')) ? 'üìÖ' : 'üí∞';
                    const gw = tx.gateway ? tx.gateway.toUpperCase() : 'UNKNOWN';

                    h += `
                        <div class="status-pill p-5 rounded-3xl flex items-center justify-between shadow-sm">
                            <div class="flex items-center gap-4">
                                <div class="w-11 h-11 bg-black/5 rounded-2xl flex items-center justify-center text-xl shadow-inner">${icon}</div>
                                <div class="text-left">
                                    <p class="text-xs font-black">${tx.purpose || '·ä≠·çç·ã´'}</p>
                                    <p class="text-[9px] font-bold opacity-30 uppercase tracking-tighter">${gw} ‚Ä¢ ${new Date((tx.timestamp?.seconds||0)*1000).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-black">${tx.totalAmount || 0} ·â•·à≠</p>
                                <span class="text-[8px] font-black px-2.5 py-1 rounded-full ${clr}">${status==='APPROVED'?'·å∏·ãµ·âã·àç':(status==='REJECTED'?'·ãç·ãµ·âÖ':'·â†·àò·å†·â£·â†·âÖ')}</span>
                            </div>
                        </div>`;
                });

                list.innerHTML = h;
                const sumMEl = document.getElementById('sumMonthly');
                const sumPEl = document.getElementById('sumPenalty');
                const totalBEl = document.getElementById('totalBalance');
                const remBEl = document.getElementById('remainingBalance');
                const pAlertEl = document.getElementById('pendingAlert');

                if (sumMEl) sumMEl.innerText = m.toLocaleString();
                if (sumPEl) sumPEl.innerText = p.toLocaleString();
                if (totalBEl) totalBEl.innerText = t.toLocaleString();
                if (remBEl) remBEl.innerText = Math.max(0, (6 * MONTHLY_FEE) - m).toLocaleString();
                if (pAlertEl) pAlertEl.classList.toggle('hidden', !pend);
            });
        }

        window.handlePreview = (i) => {
            if (i.files[0]) {
                const r = new FileReader();
                r.onload = (e) => {
                    const pr = document.getElementById('receiptPreview');
                    const ph = document.getElementById('uploadPlaceholder');
                    if(pr) { pr.src = e.target.result; pr.classList.remove('hidden'); }
                    if(ph) ph.classList.add('hidden');
                };
                r.readAsDataURL(i.files[0]);
            }
        };

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!window.currentUser) {
                tg.showPopup({ message: "·ä•·â£·ä≠·ãé ·àò·åÄ·àò·à™·ã´ ·â†·â¥·àå·åç·à´·àù ·ã≠·åç·â°" });
                return;
            }

            const amtVal = document.getElementById('amount')?.value || 0;
            const penVal = document.getElementById('penalty')?.value || 0;
            const amt = parseFloat(amtVal);
            const pen = parseFloat(penVal);
            const purpose = `${document.getElementById('paymentType').value}: ${document.getElementById('month').value} ${document.getElementById('day').value}, ${document.getElementById('year').value}`;

            if (window.paymentMode === 'easypay') {
                await initDigitalPayment(amt + pen, purpose);
                return;
            }

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;
            
            const payload = {
                type: 'payment_report',
                gateway: 'manual',
                purpose: purpose,
                baseAmount: amt,
                penaltyAmount: pen,
                totalAmount: amt + pen,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'payments'), {
                    ...payload,
                    status: 'AWAIT_APPROVAL'
                });
                tg.sendData(JSON.stringify(payload));
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => tg.close(), 1000);
            } catch (err) {
                console.error(err);
                btn.innerHTML = '·àµ·àÖ·â∞·âµ ·â∞·çà·å•·àØ·àç';
                btn.disabled = false;
                setTimeout(() => btn.innerHTML = originalText, 2000);
            }
        });

        // Event Listeners
        const daySelect = document.getElementById('day');
        const pTypeSelect = document.getElementById('paymentType');
        if (daySelect) daySelect.addEventListener('change', window.updatePenalty);
        if (pTypeSelect) pTypeSelect.addEventListener('change', window.updatePenalty);
    </script>
</body>
</html>
