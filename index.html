<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠ - Edir Digital Pro</title>
    <!-- SDK-wwan barbaachisoo -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@100..900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f1f5f9);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #0f172a);
            --brand-green: #15803d;
            --brand-light: rgba(21, 128, 61, 0.08);
            --card-border: rgba(226, 232, 240, 0.8);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tg-bg: var(--tg-theme-bg-color, #0f172a);
                --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #1e293b);
                --tg-text: var(--tg-theme-text-color, #f8fafc);
                --card-border: rgba(51, 65, 85, 0.5);
            }
        }

        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: 'Noto Sans Ethiopic', 'Inter', sans-serif;
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        .section-card {
            background-color: var(--tg-secondary-bg);
            border: 1px solid var(--card-border);
            border-radius: 2rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .input-style {
            background-color: var(--tg-bg);
            border: 2px solid var(--card-border);
            border-radius: 1.25rem;
            padding: 0.875rem 1rem;
            width: 100%;
            font-size: 14px;
            color: var(--tg-text);
            outline: none;
        }

        .method-card {
            border: 2px solid var(--card-border);
            border-radius: 1.5rem;
            padding: 1.25rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--tg-secondary-bg);
        }

        .method-card.selected {
            border-color: var(--brand-green);
            background-color: var(--brand-light);
            transform: scale(0.98);
        }

        .method-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(1);
        }

        .gateway-pill {
            border: 2px solid var(--card-border);
            border-radius: 1.25rem;
            padding: 0.75rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--tg-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .gateway-pill.selected {
            border-color: var(--brand-green);
            background-color: var(--brand-light);
            box-shadow: 0 4px 10px rgba(21, 128, 61, 0.1);
        }

        .gateway-logo {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: cover;
        }

        .upload-box {
            border: 2px dashed var(--card-border);
            border-radius: 1.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            background-color: var(--tg-bg);
            transition: all 0.3s ease;
        }

        .tab-btn { padding: 10px 4px; border-radius: 1rem; font-weight: 700; font-size: 12px; color: var(--tg-text); opacity: 0.6; }
        .active-tab { color: var(--brand-green) !important; background: var(--tg-secondary-bg); opacity: 1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .animate-section { animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Notification Center Styles */
        #notificationCenter {
            position: fixed;
            top: 0; right: -100%;
            width: 85%; height: 100%;
            background: var(--tg-secondary-bg);
            z-index: 1000;
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1.5rem;
        }
        #notificationCenter.open { right: 0; }
        .notif-card {
            padding: 1rem;
            border-radius: 1.25rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid #ddd;
            background: var(--tg-bg);
        }
        .notif-success { border-left-color: #22c55e; }
        .notif-warning { border-left-color: #eab308; }
        .notif-info { border-left-color: #3b82f6; }

        .badge-dot {
            position: absolute;
            top: -2px; right: -2px;
            width: 8px; height: 8px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid var(--tg-bg);
        }

        /* Stepper & Ledger */
        .step-circle { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; border: 2px solid var(--card-border); background: var(--tg-secondary-bg); z-index: 10; }
        .step-active { border-color: var(--brand-green); background: var(--brand-green); color: white; }
        .step-line { position: absolute; top: 12px; left: 24px; right: 10px; height: 2px; background: var(--card-border); z-index: 1; }
        
        .ledger-row { border-bottom: 1px solid var(--card-border); padding: 1rem 0; display: flex; align-items: center; justify-content: space-between; }
        .ledger-row:last-child { border-bottom: none; }
        .status-badge { font-size: 10px; font-weight: 900; padding: 2px 8px; border-radius: 50px; text-transform: uppercase; }
    </style>
</head>
<body class="p-5 pb-10">

    <header class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-green-700 rounded-2xl flex items-center justify-center shadow-lg">
                <img src="https://ui-avatars.com/api/?name=EP&background=15803d&color=fff&size=128" class="w-full h-full object-cover rounded-2xl">
            </div>
            <div>
                <h1 class="text-lg font-black leading-tight">·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠</h1>
                <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest">@Abiymersha</p>
            </div>
        </div>
        
        <button onclick="toggleNotif()" class="relative w-10 h-10 bg-black/5 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <div id="notifBadge" class="badge-dot"></div>
        </button>
    </header>

    <!-- Notification Side Panel -->
    <div id="notificationCenter">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-black">·àõ·à≥·ãà·âÇ·ã´·ãé·âΩ</h2>
            <button onclick="toggleNotif()" class="text-xs font-bold opacity-50 uppercase">·ãù·åã</button>
        </div>
        <div id="notifList" class="overflow-y-auto h-[85vh]">
            <div class="notif-card notif-success">
                <h4 class="text-xs font-black uppercase text-green-700 mb-1">·ä•·äï·ä≥·äï ·ã∞·àÖ·äì ·àò·å°</h4>
                <p class="text-[11px] font-medium opacity-70">·â†·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠ ·ã≤·åÇ·â≥·àç ·àò·â∞·åç·â†·à™·ã´ ·àã·ã≠ ·àÅ·àâ·äï·àù ·ã®·ãï·ãµ·à≠ ·ä†·åà·àç·åç·àé·â∂·âΩ ·àõ·åç·äò·âµ ·ã≠·âΩ·àã·àâ·ç¢</p>
            </div>
        </div>
    </div>

    <nav id="mainNav" class="bg-black/5 p-1 rounded-2xl grid grid-cols-4 gap-1 mb-8">
        <button onclick="showTab('payment')" id="payTab" class="tab-btn active-tab">·ä≠·çç·ã´</button>
        <button onclick="showTab('status')" id="statTab" class="tab-btn">·àÅ·äî·â≥</button>
        <button onclick="showTab('loan')" id="loanTab" class="tab-btn">·â•·ãµ·à≠</button>
        <button onclick="showTab('help')" id="helpTab" class="tab-btn">·ä•·à≠·ã≥·â≥</button>
    </nav>

    <!-- Payment Section -->
    <div id="paymentSection" class="animate-section space-y-6">
        <form id="paymentForm" class="space-y-6">
            <!-- Payer Toggle -->
            <div class="section-card space-y-5">
                <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest px-1">·ä≠·çç·ã´·ãç ·àà·àõ·äï ·äê·ãç?</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div id="selfPay" class="method-card selected" onclick="togglePayer('self')">
                        <span class="text-3xl block mb-2">üôã‚Äç‚ôÇÔ∏è</span>
                        <span class="text-xs font-black uppercase">·àà·ä•·äî</span>
                    </div>
                    <div id="otherPay" class="method-card" onclick="togglePayer('other')">
                        <span class="text-3xl block mb-2">üë•</span>
                        <span class="text-xs font-black uppercase">·àà·àå·àã ·à∞·ãç</span>
                    </div>
                </div>
                <div id="otherMemberBox" class="hidden mt-4">
                    <label class="text-[11px] font-bold uppercase opacity-50 mb-2 block ml-2">·ã®·ä†·â£·àâ ·àµ·àù/Username</label>
                    <input type="text" id="targetMember" placeholder="@username ·ãà·ã≠·àù ·àô·àâ ·àµ·àù" class="input-style">
                </div>
            </div>

            <!-- Payment Type & Date -->
            <div class="section-card space-y-6">
                <div class="space-y-2">
                    <label class="text-[11px] font-bold uppercase opacity-50 ml-2">·ã®·ä≠·çç·ã´ ·ãì·ã≠·äê·âµ</label>
                    <select id="purpose" class="input-style" onchange="handleTypeChange(); autoCalculatePenalty();">
                        <option value="·àò·ã∞·â†·äõ ·àò·ãã·åÆ">·àò·ã∞·â†·äõ ·àò·ãã·åÆ</option>
                        <option value="·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª">·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª</option>
                        <option value="·ã®·âÖ·å£·âµ ·ä≠·çç·ã´">·ã®·âÖ·å£·âµ ·ä≠·çç·ã´</option>
                        <option value="·àå·àã ·ä≠·çç·ã´">·àå·àã ·ä≠·çç·ã´</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label id="periodLabel" class="text-[11px] font-bold uppercase opacity-50 ml-2">·ã®·ä≠·çç·ã´ ·ãà·à≠/·åä·ãú (Month/Day/Year)</label>
                    <div id="dateGrid" class="grid grid-cols-3 gap-2">
                        <select id="periodMonth" class="input-style text-xs" onchange="autoCalculatePenalty()"></select>
                        <select id="periodDay" class="input-style text-xs" onchange="autoCalculatePenalty()"></select>
                        <select id="periodYear" class="input-style text-xs"></select>
                    </div>
                    <select id="periodOther" class="input-style hidden" onchange="checkPaymentRestrictions()">
                        <option value="·ãà·ã∞ ·ãï·ãµ·à≠ ·ä†·ä´·ãç·äï·âµ">·ãà·ã∞ ·ãï·ãµ·à≠ ·ä†·ä´·ãç·äï·âµ</option>
                        <option value="·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ">·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold uppercase opacity-50 ml-2">·àò·å†·äï (·â•·à≠)</label>
                        <input type="number" id="amount" placeholder="0.00" required class="input-style text-green-700 font-black">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold uppercase opacity-50 ml-2">·âÖ·å£·âµ (·â•·à≠)</label>
                        <input type="number" id="penalty" value="0" class="input-style text-red-600 font-black">
                        <p id="penaltyHint" class="text-[8px] text-red-500 font-bold mt-1 ml-2"></p>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="section-card space-y-5">
                <div class="flex items-center justify-between px-1">
                    <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest">·ã®·ä≠·çç·ã´ ·àò·äï·åà·ãµ</h3>
                    <p id="restrictionNote" class="text-[9px] text-red-500 font-bold hidden">·àà·ä†·â£·àç ·â†·ã∞·à®·à∞·äù ·â•·âª!</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div id="mManual" class="method-card selected py-4" onclick="setMode('manual')">üßæ <span class="text-[11px] font-black uppercase">·â†·ã∞·à®·à∞·äù</span></div>
                    <div id="mEasy" class="method-card py-4" onclick="setMode('easypay')">üí≥ <span class="text-[11px] font-black uppercase">·ã≤·åÇ·â≥·àç</span></div>
                </div>

                <div id="digitalGateways" class="hidden animate-section mt-4 pt-4 border-t border-black/5 space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="gateway-pill selected" onclick="selectGateway('chapa', this)">
                            <img src="https://ui-avatars.com/api/?name=C&background=15803d&color=fff" class="gateway-logo">
                            <span class="text-[9px] font-black uppercase">Chapa</span>
                        </div>
                        <div class="gateway-pill" onclick="selectGateway('telebirr', this)">
                            <img src="https://ui-avatars.com/api/?name=T&background=0052cc&color=fff" class="gateway-logo">
                            <span class="text-[9px] font-black uppercase">Telebirr</span>
                        </div>
                        <div class="gateway-pill" onclick="selectGateway('cbe', this)">
                            <img src="https://ui-avatars.com/api/?name=B&background=6a1b9a&color=fff" class="gateway-logo">
                            <span class="text-[9px] font-black uppercase">CBE Birr</span>
                        </div>
                    </div>
                </div>

                <div id="receiptUploadArea" class="animate-section mt-4 pt-4 border-t border-black/5 space-y-3">
                    <div class="upload-box" onclick="document.getElementById('receiptFile').click()">
                        <div id="uploadPlaceholder">üì∏ <span class="text-[10px] font-black uppercase opacity-60">·ã∞·à®·à∞·äù ·àà·àò·å´·äï ·ä•·ãö·àÖ ·ã≠·äï·ä©</span></div>
                        <img id="previewImage" class="hidden mx-auto max-h-48 rounded-xl" alt="Preview">
                    </div>
                    <input type="file" id="receiptFile" class="hidden" accept="image/*" onchange="previewReceipt(this)">
                </div>
            </div>

            <button type="submit" class="w-full py-5 bg-green-700 text-white rounded-[1.5rem] font-black text-lg shadow-xl active:scale-[0.97] transition-all">·àò·à®·åÉ·ãç·äï ·àã·ä≠</button>
        </form>
    </div>

    <!-- Status Section (Bookkeeping) -->
    <div id="statusSection" class="hidden animate-section space-y-6">
        <div class="section-card bg-slate-900 text-white border-none p-6 shadow-2xl relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-green-500/20 rounded-full blur-3xl"></div>
            <p class="text-[10px] font-bold uppercase opacity-50 tracking-widest mb-1 text-green-400">·ä†·å†·âÉ·àã·ã≠ ·âÅ·å†·â£</p>
            <div class="flex items-baseline gap-2">
                <span class="text-5xl font-black">2,450.00</span>
                <span class="text-sm font-bold opacity-60">·â•·à≠</span>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-8 pt-6 border-t border-white/10">
                <div><p class="text-[9px] uppercase opacity-40 mb-1">·ã´·àç·â∞·ä®·çà·àà ·âÖ·å£·âµ</p><p class="text-lg font-black text-red-400">0.00</p></div>
                <div class="text-right"><p class="text-[9px] uppercase opacity-40 mb-1">·ã∞·à®·åÉ</p><p class="text-lg font-black text-green-400">·çï·àÆ (Pro)</p></div>
            </div>
        </div>

        <div class="section-card space-y-4">
            <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest">·ã®·ä≠·çç·ã´ ·àò·ãù·åà·â• (Passbook)</h3>
            <div class="space-y-1">
                <div class="ledger-row">
                    <div><p class="text-sm font-black">·àò·ã∞·â†·äõ ·àò·ãã·åÆ (·å•·à≠)</p><p class="text-[10px] opacity-40">·å•·à≠ 12, 2017</p></div>
                    <div class="text-right"><p class="text-sm font-black">+100.00</p><span class="status-badge bg-green-100 text-green-700">·ã®·å∏·ã∞·âÄ</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Section -->
    <div id="loanSection" class="hidden animate-section space-y-6">
        <div class="section-card p-6 bg-slate-50 border-none">
            <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest mb-6 text-center">·ã®·â•·ãµ·à≠ ·àÇ·ã∞·âµ (Progress)</h3>
            <div class="relative flex justify-between items-start">
                <div class="step-line"></div>
                <div class="flex flex-col items-center gap-2 relative z-10"><div class="step-circle step-active">1</div><span class="text-[8px] font-black uppercase">·å•·ã´·âÑ</span></div>
                <div class="flex flex-col items-center gap-2 relative z-10"><div class="step-circle">2</div><span class="text-[8px] font-black uppercase opacity-40">·àù·à≠·àò·à´</span></div>
                <div class="flex flex-col items-center gap-2 relative z-10"><div class="step-circle">3</div><span class="text-[8px] font-black uppercase opacity-40">·ãç·à≥·äî</span></div>
                <div class="flex flex-col items-center gap-2 relative z-10"><div class="step-circle">4</div><span class="text-[8px] font-black uppercase opacity-40">·à≠·ä≠·ä≠·â•</span></div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <div class="section-card p-5 border-l-4 border-l-slate-400 flex justify-between items-center">
                <div><h4 class="text-[10px] font-black opacity-50 uppercase">·àò·à†·à®·â≥·ãä ·ä†·â£·àç</h4><p class="text-xl font-black">5,000 ·â•·à≠</p></div>
                <div class="text-[9px] font-black bg-slate-100 px-3 py-1 rounded-full">·ã∞·à®·åÉ 1</div>
            </div>
            <div class="section-card p-5 border-l-4 border-l-green-600 flex justify-between items-center bg-green-50/30">
                <div><h4 class="text-[10px] font-black text-green-700 uppercase">·çï·àÆ ·ä†·â£·àç (Pro)</h4><p class="text-xl font-black text-green-800">15,000 ·â•·à≠</p></div>
                <div class="text-[9px] font-black bg-green-100 text-green-700 px-3 py-1 rounded-full">·ã∞·à®·åÉ 2</div>
            </div>
        </div>
        <button disabled class="w-full py-4 bg-slate-200 text-slate-500 rounded-2xl font-black text-xs uppercase cursor-not-allowed">·ã®·â•·ãµ·à≠ ·ä†·åà·àç·åç·àé·âµ ·â†·âÖ·à≠·â° ·ã≠·ä®·çà·â≥·àç</button>
    </div>

    <!-- Help Section -->
    <div id="helpSection" class="hidden animate-section p-4">
        <div class="section-card space-y-6">
            <h2 class="text-xl font-black">·ä•·à≠·ã≥·â≥ ·ä•·äì ·ã∞·åã·çç</h2>
            <div class="space-y-4">
                <div class="p-4 bg-black/5 rounded-2xl">
                    <p class="text-xs font-black text-green-700 uppercase mb-1">·àò·ã∞·â†·äõ ·àò·ãã·åÆ</p>
                    <p class="text-sm font-bold leading-relaxed">·ä®·âÄ·äï 1-5 ·àò·ã∞·â†·äõ ·ä≠·çç·ã´·ç¢ ·ä®·âÄ·äï 6-10 ·âÖ·å£·âµ 20 ·â•·à≠·ç¢ ·ä®·âÄ·äï 11 ·â†·äã·àã 50 ·â•·à≠ ·âÖ·å£·âµ ·ã≠·â≥·à∞·â£·àç·ç¢</p>
                </div>
            </div>
            <div class="pt-4 border-t border-black/5 text-center">
                <p class="text-[10px] font-bold opacity-40 uppercase mb-3">·ä†·àµ·â∞·ã≥·ã≥·à™·ãç·äï ·ã´·äê·åã·åç·à©</p>
                <a href="https://t.me/Abiymersha" class="block w-full py-4 bg-green-700 text-white rounded-2xl font-black text-sm shadow-lg active:scale-95">@Abiymersha</a>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let payerMode = 'self';
        let payMode = 'manual';
        let digitalGateway = 'chapa';

        const months = ["·àò·àµ·ä®·à®·àù", "·å•·âÖ·àù·âµ", "·àÖ·ã≥·à≠", "·â≥·àÖ·à≥·àµ", "·å•·à≠", "·ã®·ä´·â≤·âµ", "·àò·åã·â¢·âµ", "·àö·ã´·ãù·ã´", "·åç·äï·â¶·âµ", "·à∞·äî", "·àê·àù·àå", "·äê·àê·à¥"];
        const currentYear = 2017; 

        function populateDateSelectors() {
            const mSelect = document.getElementById('periodMonth');
            const dSelect = document.getElementById('periodDay');
            const ySelect = document.getElementById('periodYear');
            mSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
            let days = "";
            for(let i=1; i<=30; i++) days += `<option value="${i}">${i}</option>`;
            dSelect.innerHTML = days;
            ySelect.innerHTML = `<option value="${currentYear-1}">${currentYear-1}</option><option value="${currentYear}" selected>${currentYear}</option><option value="${currentYear+1}">${currentYear+1}</option>`;
        }

        function autoCalculatePenalty() {
            const purpose = document.getElementById('purpose').value;
            const day = parseInt(document.getElementById('periodDay').value);
            const penaltyInput = document.getElementById('penalty');
            const hint = document.getElementById('penaltyHint');
            let p = 0;
            let note = "";

            if (purpose === "·àò·ã∞·â†·äõ ·àò·ãã·åÆ") {
                if (day >= 6 && day <= 10) { p = 20; note = "·ã®·âÄ·äï 6-10 ·âÖ·å£·âµ (20 ·â•·à≠)"; }
                else if (day >= 11) { p = 50; note = "·ä®·âÄ·äï 11 ·â†·äã·àã ·âÖ·å£·âµ (50 ·â•·à≠)"; }
                else { note = "·àò·ã∞·â†·äõ ·åä·ãú (·âÖ·å£·âµ ·ã®·àà·àù)"; }
            }
            penaltyInput.value = p;
            hint.innerText = note;
        }

        function checkPaymentRestrictions() {
            const purpose = document.getElementById('purpose').value;
            const periodOther = document.getElementById('periodOther').value;
            const mEasy = document.getElementById('mEasy');
            const note = document.getElementById('restrictionNote');
            if (purpose === "·àå·àã ·ä≠·çç·ã´" && periodOther === "·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ") {
                setMode('manual');
                mEasy.classList.add('disabled');
                note.classList.remove('hidden');
            } else {
                mEasy.classList.remove('disabled');
                note.classList.add('hidden');
            }
        }

        function handleTypeChange() {
            const purpose = document.getElementById('purpose').value;
            const label = document.getElementById('periodLabel');
            const dateGrid = document.getElementById('dateGrid');
            const periodOther = document.getElementById('periodOther');
            if (purpose === "·àå·àã ·ä≠·çç·ã´") {
                label.innerText = "·ã®·ä≠·çç·ã´ ·ãì·àã·àõ (Purpose)";
                dateGrid.classList.add('hidden');
                periodOther.classList.remove('hidden');
            } else {
                label.innerText = "·ã®·ä≠·çç·ã´ ·ãà·à≠/·åä·ãú (Month/Day/Year)";
                dateGrid.classList.remove('hidden');
                periodOther.classList.add('hidden');
            }
            checkPaymentRestrictions();
        }

        window.showTab = (tabName) => {
            ['payment', 'status', 'loan', 'help'].forEach(s => {
                document.getElementById(s + 'Section')?.classList.toggle('hidden', s !== tabName);
                document.getElementById(s + 'Tab')?.classList.toggle('active-tab', s === tabName);
            });
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleNotif = () => {
            document.getElementById('notificationCenter').classList.toggle('open');
            document.getElementById('notifBadge').classList.add('hidden');
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        };

        window.togglePayer = (mode) => {
            payerMode = mode;
            document.getElementById('selfPay').classList.toggle('selected', mode === 'self');
            document.getElementById('otherPay').classList.toggle('selected', mode === 'other');
            document.getElementById('otherMemberBox').classList.toggle('hidden', mode === 'self');
        };

        window.setMode = (m) => {
            const purpose = document.getElementById('purpose').value;
            const periodOther = document.getElementById('periodOther').value;
            if (m === 'easypay' && purpose === "·àå·àã ·ä≠·çç·ã´" && periodOther === "·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ") return;
            payMode = m;
            document.getElementById('mManual').classList.toggle('selected', m === 'manual');
            document.getElementById('mEasy').classList.toggle('selected', m === 'easypay');
            document.getElementById('receiptUploadArea').classList.toggle('hidden', m !== 'manual');
            document.getElementById('digitalGateways').classList.toggle('hidden', m !== 'easypay');
        };

        window.selectGateway = (gw, el) => {
            digitalGateway = gw;
            document.querySelectorAll('.gateway-pill').forEach(p => p.classList.remove('selected'));
            el.classList.add('selected');
        };

        window.previewReceipt = (input) => {
            const preview = document.getElementById('previewImage');
            const placeholder = document.getElementById('uploadPlaceholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result; preview.style.display = 'block'; placeholder.style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        document.getElementById('paymentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const purpose = document.getElementById('purpose').value;
            let finalPeriod = "";
            if (purpose === "·àå·àã ·ä≠·çç·ã´") {
                finalPeriod = document.getElementById('periodOther').value;
            } else {
                finalPeriod = `${document.getElementById('periodMonth').value} ${document.getElementById('periodDay').value}, ${document.getElementById('periodYear').value}`;
            }
            const payload = {
                type: 'payment_report',
                gateway: (payMode === 'manual') ? 'manual' : digitalGateway,
                purpose: purpose,
                period: finalPeriod,
                amount: document.getElementById('amount').value,
                penalty: document.getElementById('penalty').value,
                payFor: payerMode === 'self' ? 'self' : document.getElementById('targetMember').value
            };
            tg.sendData(JSON.stringify(payload));
            tg.close();
        });

        populateDateSelectors();
        handleTypeChange();
        if(tg.initDataUnsafe?.user) document.getElementById('userName').innerText = tg.initDataUnsafe.user.first_name;
    </script>
</body>
</html>
