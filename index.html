<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠ - Edir Digital Pro</title>
    <!-- SDK-wwan barbaachisoo -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@100..900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f1f5f9);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #0f172a);
            --brand-green: #15803d;
            --brand-light: rgba(21, 128, 61, 0.08);
            --card-border: rgba(226, 232, 240, 0.8);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tg-bg: var(--tg-theme-bg-color, #0f172a);
                --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #1e293b);
                --tg-text: var(--tg-theme-text-color, #f8fafc);
                --card-border: rgba(51, 65, 85, 0.5);
            }
        }

        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: 'Noto Sans Ethiopic', 'Inter', sans-serif;
            margin: 0; padding: 0;
            transition: all 0.3s ease;
        }

        .section-card {
            background-color: var(--tg-secondary-bg);
            border: 1px solid var(--card-border);
            border-radius: 2rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .input-style {
            background-color: var(--tg-bg);
            border: 2px solid var(--card-border);
            border-radius: 1.25rem;
            padding: 0.875rem 1rem;
            width: 100%;
            font-size: 14px;
            color: var(--tg-text);
            outline: none;
        }

        .method-card {
            border: 2px solid var(--card-border);
            border-radius: 1.5rem;
            padding: 1.25rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--tg-secondary-bg);
        }

        .method-card.selected {
            border-color: var(--brand-green);
            background-color: var(--brand-light);
            transform: scale(0.98);
        }

        .method-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(1);
        }

        .gateway-pill {
            border: 2px solid var(--card-border);
            border-radius: 1.25rem;
            padding: 0.75rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--tg-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .gateway-pill.selected {
            border-color: var(--brand-green);
            background-color: var(--brand-light);
            box-shadow: 0 4px 10px rgba(21, 128, 61, 0.1);
        }

        .gateway-logo {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: cover;
            background-color: white;
        }

        .upload-box {
            border: 2px dashed var(--card-border);
            border-radius: 1.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            background-color: var(--tg-bg);
            transition: all 0.3s ease;
        }
        .upload-box:hover { border-color: var(--brand-green); background-color: var(--brand-light); }
        .preview-img { width: 100%; max-height: 200px; object-fit: contain; border-radius: 1rem; margin-top: 1rem; display: none; }

        .tab-btn { padding: 10px 4px; border-radius: 1rem; font-weight: 700; font-size: 12px; color: var(--tg-text); opacity: 0.6; }
        .active-tab { color: var(--brand-green) !important; background: var(--tg-secondary-bg); opacity: 1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .animate-section { animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Status Section Styles */
        .ledger-row {
            border-bottom: 1px solid var(--card-border);
            padding: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ledger-row:last-child { border-bottom: none; }
        .status-badge {
            font-size: 10px;
            font-weight: 900;
            padding: 2px 8px;
            border-radius: 50px;
            text-transform: uppercase;
        }
        .status-approved { background: #dcfce7; color: #15803d; }
        .status-pending { background: #fef9c3; color: #a16207; }
        .status-rejected { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body class="p-5 pb-10">

    <header class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-green-700 rounded-2xl flex items-center justify-center shadow-lg overflow-hidden">
                <img src="https://ui-avatars.com/api/?name=EP&background=15803d&color=fff&size=128" alt="Logo" class="w-full h-full object-cover">
            </div>
            <div>
                <h1 class="text-lg font-black leading-tight">·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠</h1>
                <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest">Digital Edir</p>
            </div>
        </div>
        <div class="text-right">
            <span id="userName" class="text-sm font-black block">·ä†·â£·àç</span>
            <span class="text-[10px] opacity-40 uppercase font-bold tracking-tighter">Edir Digital Pro</span>
        </div>
    </header>

    <nav id="mainNav" class="bg-black/5 p-1 rounded-2xl grid grid-cols-4 gap-1 mb-8">
        <button onclick="showTab('payment')" id="payTab" class="tab-btn active-tab">·ä≠·çç·ã´</button>
        <button onclick="showTab('status')" id="statTab" class="tab-btn">·àÅ·äî·â≥</button>
        <button onclick="showTab('loan')" id="loanTab" class="tab-btn">·â•·ãµ·à≠</button>
        <button onclick="showTab('help')" id="helpTab" class="tab-btn">·ä•·à≠·ã≥·â≥</button>
    </nav>

    <!-- Payment Section -->
    <div id="paymentSection" class="animate-section">
        <form id="paymentForm" class="space-y-6">
            <!-- Payer Selection -->
            <div class="section-card space-y-5">
                <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest px-1">·ä≠·çç·ã´·ãç ·àà·àõ·äï ·äê·ãç?</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div id="selfPay" class="method-card selected" onclick="togglePayer('self')">
                        <span class="text-3xl block mb-2">üôã‚Äç‚ôÇÔ∏è</span>
                        <span class="text-xs font-black uppercase">·àà·ä•·äî</span>
                    </div>
                    <div id="otherPay" class="method-card" onclick="togglePayer('other')">
                        <span class="text-3xl block mb-2">üë•</span>
                        <span class="text-xs font-black uppercase">·àà·àå·àã ·à∞·ãç</span>
                    </div>
                </div>
                <div id="otherMemberBox" class="hidden mt-4">
                    <label class="text-[11px] font-bold uppercase opacity-50 mb-2 block ml-2">·ã®·ä†·â£·àâ ·àµ·àù/Username</label>
                    <input type="text" id="targetMember" placeholder="@username ·ãà·ã≠·àù ·àô·àâ ·àµ·àù" class="input-style">
                </div>
            </div>

            <!-- Gosoota kaffaltii -->
            <div class="section-card space-y-6">
                <div class="space-y-2">
                    <label class="text-[11px] font-bold uppercase opacity-50 ml-2">·ã®·ä≠·çç·ã´ ·ãì·ã≠·äê·âµ</label>
                    <select id="purpose" class="input-style" onchange="handleTypeChange()">
                        <option value="·àò·ã∞·â†·äõ ·àò·ãã·åÆ">·àò·ã∞·â†·äõ ·àò·ãã·åÆ</option>
                        <option value="·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª">·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª</option>
                        <option value="·ã®·âÖ·å£·âµ ·ä≠·çç·ã´">·ã®·âÖ·å£·âµ ·ä≠·çç·ã´</option>
                        <option value="·àå·àã ·ä≠·çç·ã´">·àå·àã ·ä≠·çç·ã´</option>
                    </select>
                </div>

                <!-- Month / Date / Year Selection -->
                <div class="space-y-2">
                    <label id="periodLabel" class="text-[11px] font-bold uppercase opacity-50 ml-2">·ã®·ä≠·çç·ã´ ·ãà·à≠/·åä·ãú (Month/Date/Year)</label>
                    
                    <div id="dateGrid" class="grid grid-cols-3 gap-2">
                        <select id="periodMonth" class="input-style text-xs" onchange="checkPaymentRestrictions()"></select>
                        <select id="periodDay" class="input-style text-xs"></select>
                        <select id="periodYear" class="input-style text-xs"></select>
                    </div>

                    <select id="periodOther" class="input-style hidden" onchange="checkPaymentRestrictions()">
                        <option value="·ãà·ã∞ ·ãï·ãµ·à≠ ·ä†·ä´·ãç·äï·âµ">·ãà·ã∞ ·ãï·ãµ·à≠ ·ä†·ä´·ãç·äï·âµ (To Edir Account)</option>
                        <option value="·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ">·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ (To Member Account)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold uppercase opacity-50 ml-2">·àò·å†·äï (·â•·à≠)</label>
                        <input type="number" id="amount" placeholder="0.00" required class="input-style text-green-700 font-black">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold uppercase opacity-50 ml-2">·âÖ·å£·âµ (·â•·à≠)</label>
                        <input type="number" id="penalty" value="0" class="input-style text-red-600 font-black">
                    </div>
                </div>
            </div>

            <!-- Akkaataa kaffaltii -->
            <div class="section-card space-y-5">
                <div class="flex items-center justify-between px-1">
                    <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest">·ã®·ä≠·çç·ã´ ·àò·äï·åà·ãµ</h3>
                    <p id="restrictionNote" class="text-[9px] text-red-500 font-bold hidden">·àà·ä†·â£·àç ·â†·ã∞·à®·à∞·äù ·â•·âª!</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div id="mManual" class="method-card selected py-4" onclick="setMode('manual')">
                        <span class="text-xl block mb-1">üßæ</span>
                        <span class="text-[11px] font-black uppercase">·â†·ã∞·à®·à∞·äù</span>
                    </div>
                    <div id="mEasy" class="method-card py-4" onclick="setMode('easypay')">
                        <span class="text-xl block mb-1">üí≥</span>
                        <span class="text-[11px] font-black uppercase">·ã≤·åÇ·â≥·àç</span>
                    </div>
                </div>

                <!-- Digital Payment Options -->
                <div id="digitalGateways" class="hidden animate-section mt-4 pt-4 border-t border-black/5 space-y-4">
                    <h4 class="text-[10px] font-bold uppercase opacity-40 text-center tracking-widest">·àò·â∞·åç·â†·à™·ã´ ·ã≠·àù·à®·å°</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="gateway-pill selected" onclick="selectGateway('chapa', this)">
                            <img src="https://ui-avatars.com/api/?name=C&background=15803d&color=fff" class="gateway-logo" alt="Chapa">
                            <span class="text-[9px] font-black uppercase">Chapa</span>
                        </div>
                        <div class="gateway-pill" onclick="selectGateway('telebirr', this)">
                            <img src="https://ui-avatars.com/api/?name=T&background=0052cc&color=fff" class="gateway-logo" alt="Telebirr">
                            <span class="text-[9px] font-black uppercase">Telebirr</span>
                        </div>
                        <div class="gateway-pill" onclick="selectGateway('cbe', this)">
                            <img src="https://ui-avatars.com/api/?name=B&background=6a1b9a&color=fff" class="gateway-logo" alt="CBE Birr">
                            <span class="text-[9px] font-black uppercase">CBE Birr</span>
                        </div>
                    </div>
                </div>

                <div id="receiptUploadArea" class="animate-section mt-4 pt-4 border-t border-black/5 space-y-3">
                    <h4 class="text-[10px] font-bold uppercase opacity-40 text-center tracking-widest">·ã®·â£·äï·ä≠ ·ã∞·à®·à∞·äù ·ã≠·å´·äë</h4>
                    <div class="upload-box" onclick="document.getElementById('receiptFile').click()">
                        <div id="uploadPlaceholder">
                            <span class="text-3xl block mb-2">üì∏</span>
                            <span class="text-[10px] font-black uppercase opacity-60">·ã∞·à®·à∞·äù ·àà·àò·å´·äï ·ä•·ãö·àÖ ·ã≠·äï·ä©</span>
                        </div>
                        <img id="previewImage" class="preview-img mx-auto" alt="Receipt Preview">
                    </div>
                    <input type="file" id="receiptFile" class="hidden" accept="image/*" onchange="previewReceipt(this)">
                </div>
            </div>

            <button type="submit" class="w-full py-5 bg-green-700 text-white rounded-[1.5rem] font-black text-lg shadow-xl active:scale-[0.97] transition-all flex items-center justify-center gap-3">
                ·àò·à®·åÉ·ãç·äï ·àã·ä≠
            </button>
        </form>
    </div>

    <!-- Status Section (Bookkeeping Method) -->
    <div id="statusSection" class="hidden animate-section space-y-6">
        <!-- Summary Card -->
        <div class="section-card bg-slate-900 text-white border-none p-6 shadow-2xl relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-green-500/20 rounded-full blur-3xl"></div>
            <div class="flex justify-between items-start mb-6">
                <div>
                    <p class="text-[10px] font-bold uppercase opacity-50 tracking-widest mb-1">·ä†·å†·âÉ·àã·ã≠ ·âÅ·å†·â£ (Total Savings)</p>
                    <div class="flex items-baseline gap-2">
                        <span class="text-4xl font-black">1,500</span>
                        <span class="text-sm font-bold opacity-60">·â•·à≠</span>
                    </div>
                </div>
                <div class="bg-green-600/20 px-3 py-1 rounded-full border border-green-500/30">
                    <span class="text-[10px] font-black text-green-400 uppercase">·çï·àÆ ·ä†·â£·àç (Pro)</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mt-8 pt-6 border-t border-white/10">
                <div>
                    <p class="text-[9px] uppercase opacity-40 mb-1">·å†·âÖ·àã·àã ·âÖ·å£·âµ</p>
                    <p class="text-lg font-black text-red-400">20.00 <span class="text-[10px]">·â•·à≠</span></p>
                </div>
                <div class="text-right">
                    <p class="text-[9px] uppercase opacity-40 mb-1">·ã®·å∏·ã∞·âÅ ·ä≠·çç·ã´·ãé·âΩ</p>
                    <p class="text-lg font-black">15 <span class="text-[10px]">·åä·ãú</span></p>
                </div>
            </div>
        </div>

        <!-- Ledger / Transaction History -->
        <div class="section-card space-y-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest px-1">·ã®·ä≠·çç·ã´ ·àò·ãù·åà·â• (Passbook)</h3>
                <span class="text-[10px] font-bold opacity-30">·ã®·àò·å®·à®·àª 5 ·ä•·äï·âÖ·àµ·âÉ·à¥·ãé·âΩ</span>
            </div>
            
            <div class="space-y-1">
                <!-- Ledger Row 1 -->
                <div class="ledger-row">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center text-green-700 text-lg">üí∞</div>
                        <div>
                            <p class="text-sm font-black">·àò·ã∞·â†·äõ ·àò·ãã·åÆ (·å•·à≠)</p>
                            <p class="text-[10px] opacity-40">·å•·à≠ 12, 2017</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black">+100.00</p>
                        <span class="status-badge status-approved">·ã®·å∏·ã∞·âÄ</span>
                    </div>
                </div>

                <!-- Ledger Row 2 -->
                <div class="ledger-row">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-yellow-100 rounded-xl flex items-center justify-center text-yellow-700 text-lg">‚è≥</div>
                        <div>
                            <p class="text-sm font-black">·àò·ã∞·â†·äõ ·àò·ãã·åÆ (·ã®·ä´·â≤·âµ)</p>
                            <p class="text-[10px] opacity-40">·ã®·ä´·â≤·âµ 05, 2017</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black">+100.00</p>
                        <span class="status-badge status-pending">·â†·àò·å†·â£·â†·âÖ ·àã·ã≠</span>
                    </div>
                </div>

                <!-- Ledger Row 3 -->
                <div class="ledger-row">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center text-red-700 text-lg">‚ö†Ô∏è</div>
                        <div>
                            <p class="text-sm font-black">·ã®·âÖ·å£·âµ ·ä≠·çç·ã´</p>
                            <p class="text-[10px] opacity-40">·â≥·àÖ·à≥·àµ 28, 2016</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-red-600">+20.00</p>
                        <span class="status-badge status-approved">·ã®·å∏·ã∞·âÄ</span>
                    </div>
                </div>

                <!-- Ledger Row 4 -->
                <div class="ledger-row">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-700 text-lg">üîÑ</div>
                        <div>
                            <p class="text-sm font-black">·àå·àã ·ä≠·çç·ã´ (·àà·ä†·â£·àç)</p>
                            <p class="text-[10px] opacity-40">·àÖ·ã≥·à≠ 15, 2016</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black">+250.00</p>
                        <span class="status-badge status-approved">·ã®·å∏·ã∞·âÄ</span>
                    </div>
                </div>
            </div>

            <div class="pt-4">
                <button class="w-full py-3 bg-slate-50 text-[10px] font-black uppercase opacity-40 tracking-widest rounded-xl">·àô·àâ ·àò·ãù·åà·â• ·ã≠·àò·àç·ä®·â± (See All)</button>
            </div>
        </div>
    </div>

    <!-- Loan Section -->
    <div id="loanSection" class="hidden animate-section p-10 text-center italic opacity-50">·ã®·â•·ãµ·à≠ ·ä†·åà·àç·åç·àé·âµ ·â†·âÖ·à≠·â°::</div>
    
    <!-- Help Section -->
    <div id="helpSection" class="hidden animate-section p-4">
        <div class="section-card space-y-4">
            <h2 class="text-lg font-black">·ä•·à≠·ã≥·â≥</h2>
            <p class="text-xs opacity-60">·ä≠·çç·ã´ ·â†·ã∞·à®·à∞·äù ·ãà·ã≠·àù ·â†·ã≤·åÇ·â≥·àç ·àò·â∞·åç·â†·à™·ã´·ãé·âΩ ·àò·çà·å∏·àù ·ã≠·âΩ·àã·àâ::</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        let payerMode = 'self';
        let payMode = 'manual';
        let digitalGateway = 'chapa';

        const months = ["·àò·àµ·ä®·à®·àù", "·å•·âÖ·àù·âµ", "·àÖ·ã≥·à≠", "·â≥·àÖ·à≥·àµ", "·å•·à≠", "·ã®·ä´·â≤·âµ", "·àò·åã·â¢·âµ", "·àö·ã´·ãù·ã´", "·åç·äï·â¶·âµ", "·à∞·äî", "·àê·àù·àå", "·äê·àê·à¥"];
        const currentYear = 2017; 

        function populateDateSelectors() {
            const mSelect = document.getElementById('periodMonth');
            const dSelect = document.getElementById('periodDay');
            const ySelect = document.getElementById('periodYear');
            mSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
            let days = "";
            for(let i=1; i<=30; i++) days += `<option value="${i}">${i}</option>`;
            dSelect.innerHTML = days;
            ySelect.innerHTML = `<option value="${currentYear-1}">${currentYear-1}</option><option value="${currentYear}" selected>${currentYear}</option><option value="${currentYear+1}">${currentYear+1}</option>`;
        }

        function checkPaymentRestrictions() {
            const purpose = document.getElementById('purpose').value;
            const periodOther = document.getElementById('periodOther').value;
            const mEasy = document.getElementById('mEasy');
            const note = document.getElementById('restrictionNote');
            if (purpose === "·àå·àã ·ä≠·çç·ã´" && periodOther === "·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ") {
                setMode('manual');
                mEasy.classList.add('disabled');
                note.classList.remove('hidden');
            } else {
                mEasy.classList.remove('disabled');
                note.classList.add('hidden');
            }
        }

        function handleTypeChange() {
            const purpose = document.getElementById('purpose').value;
            const label = document.getElementById('periodLabel');
            const dateGrid = document.getElementById('dateGrid');
            const periodOther = document.getElementById('periodOther');
            if (purpose === "·àå·àã ·ä≠·çç·ã´") {
                label.innerText = "·ã®·ä≠·çç·ã´ ·ãì·àã·àõ (Purpose)";
                dateGrid.classList.add('hidden');
                periodOther.classList.remove('hidden');
            } else {
                label.innerText = "·ã®·ä≠·çç·ã´ ·ãà·à≠/·åä·ãú (Month/Date/Year)";
                dateGrid.classList.remove('hidden');
                periodOther.classList.add('hidden');
            }
            checkPaymentRestrictions();
        }

        window.showTab = (tabName) => {
            ['payment', 'status', 'loan', 'help'].forEach(s => {
                document.getElementById(s + 'Section')?.classList.toggle('hidden', s !== tabName);
                document.getElementById(s + 'Tab')?.classList.toggle('active-tab', s === tabName);
            });
            tg.HapticFeedback.impactOccurred('medium');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.togglePayer = (mode) => {
            payerMode = mode;
            document.getElementById('selfPay').classList.toggle('selected', mode === 'self');
            document.getElementById('otherPay').classList.toggle('selected', mode === 'other');
            document.getElementById('otherMemberBox').classList.toggle('hidden', mode === 'self');
        };

        window.setMode = (m) => {
            const purpose = document.getElementById('purpose').value;
            const periodOther = document.getElementById('periodOther').value;
            if (m === 'easypay' && purpose === "·àå·àã ·ä≠·çç·ã´" && periodOther === "·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ") return;
            payMode = m;
            document.getElementById('mManual').classList.toggle('selected', m === 'manual');
            document.getElementById('mEasy').classList.toggle('selected', m === 'easypay');
            document.getElementById('receiptUploadArea').classList.toggle('hidden', m !== 'manual');
            document.getElementById('digitalGateways').classList.toggle('hidden', m !== 'easypay');
        };

        window.selectGateway = (gw, el) => {
            digitalGateway = gw;
            document.querySelectorAll('.gateway-pill').forEach(p => p.classList.remove('selected'));
            el.classList.add('selected');
        };

        window.previewReceipt = (input) => {
            const preview = document.getElementById('previewImage');
            const placeholder = document.getElementById('uploadPlaceholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result; preview.style.display = 'block'; placeholder.style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        document.getElementById('paymentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const purpose = document.getElementById('purpose').value;
            let finalPeriod = "";
            if (purpose === "·àå·àã ·ä≠·çç·ã´") {
                finalPeriod = document.getElementById('periodOther').value;
            } else {
                const m = document.getElementById('periodMonth').value;
                const d = document.getElementById('periodDay').value;
                const y = document.getElementById('periodYear').value;
                finalPeriod = `${m} ${d}, ${y}`;
            }
            const payload = {
                type: 'payment_report',
                gateway: (payMode === 'manual') ? 'manual' : digitalGateway,
                purpose: purpose,
                period: finalPeriod,
                amount: document.getElementById('amount').value,
                penalty: document.getElementById('penalty').value,
                payFor: payerMode === 'self' ? 'self' : document.getElementById('targetMember').value
            };
            tg.sendData(JSON.stringify(payload));
            tg.close();
        });

        populateDateSelectors();
        handleTypeChange();
        if(tg.initDataUnsafe?.user) document.getElementById('userName').innerText = tg.initDataUnsafe.user.first_name;
    </script>
</body>
</html>
