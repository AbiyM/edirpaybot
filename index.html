<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠ - Edir Digital Pro</title>
    <!-- SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@100..900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f8fafc);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #0f172a);
            --tg-hint: var(--tg-theme-hint-color, #64748b);
            --tg-link: var(--tg-theme-link-color, #15803d);
            --brand-green: #15803d;
            --brand-light: rgba(21, 128, 61, 0.08);
            --card-border: rgba(226, 232, 240, 0.8);
        }

        @media (prefers-color-scheme: dark) {
            :root { --card-border: rgba(51, 65, 85, 0.5); }
        }

        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: 'Noto Sans Ethiopic', 'Inter', sans-serif;
            margin: 0; padding: 0; overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease;
            font-size: 15px;
        }

        .glass-header {
            background: rgba(var(--tg-theme-bg-color-rgb, 255, 255, 255), 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
        }

        .nav-container {
            background-color: var(--brand-green);
            box-shadow: 0 10px 25px -5px rgba(21, 128, 61, 0.4);
            border-radius: 1.5rem;
            padding: 6px;
        }

        .nav-btn {
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 800;
            font-size: 13px; /* Increased from 11px */
            border-radius: 1.1rem;
            text-transform: uppercase;
        }

        .active-tab {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .section-card {
            background-color: var(--tg-secondary-bg);
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .method-card {
            border: 2px solid var(--card-border);
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--tg-secondary-bg);
        }

        .method-card.selected {
            background-color: var(--brand-green) !important;
            border-color: var(--brand-green);
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -5px rgba(21, 128, 61, 0.3);
        }

        .gateway-pill {
            border: 2px solid var(--card-border);
            transition: all 0.2s ease;
            cursor: pointer;
            filter: grayscale(1);
            opacity: 0.7;
            background-color: var(--tg-bg);
        }

        .gateway-pill.selected {
            border-color: var(--brand-green);
            background-color: var(--brand-light);
            filter: grayscale(0);
            opacity: 1;
            transform: scale(1.05);
        }

        .input-style {
            background-color: var(--tg-bg);
            border: 2px solid var(--card-border);
            border-radius: 1rem;
            padding: 1rem; /* Increased padding */
            width: 100%;
            font-size: 16px; /* Optimized for mobile input */
            color: var(--tg-text);
            transition: all 0.2s;
        }

        .input-style:disabled {
            opacity: 0.8;
            background-color: rgba(0,0,0,0.04);
        }

        .status-pill { background-color: var(--tg-bg); border: 1px solid var(--card-border); }
        .animate-section { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Tier Colors */
        .tier-basic { color: #64748b; font-weight: 900; }
        .tier-pro { color: #2563eb; font-weight: 900; }
        .tier-elite { color: #d97706; font-weight: 900; }

        /* Locked Features UI */
        .locked-feature {
            position: relative;
            overflow: hidden;
        }
        .locked-badge {
            position: absolute;
            top: 10px;
            right: -20px;
            background: #64748b;
            color: white;
            font-size: 9px;
            font-weight: 900;
            padding: 2px 25px;
            transform: rotate(45deg);
        }
    </style>
</head>
<body class="select-none">

    <header class="glass-header sticky top-0 z-50 px-5 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="logo.jpg" class="w-12 h-12 rounded-2xl shadow-lg border-2 border-white/10 object-cover" onerror="this.style.display='none'">
            <div>
                <h1 class="text-base font-black uppercase tracking-tight leading-none">·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠</h1>
                <div class="flex items-center gap-1.5 mt-2">
                    <span class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                    <p class="text-[11px] text-green-600 font-black uppercase tracking-wide">·à≤·àµ·â∞·àô ·ä≠·çç·âµ ·äê·ãç</p>
                </div>
            </div>
        </div>
        <div class="text-right">
            <span id="userName" class="text-sm font-black block truncate max-w-[120px]">·ä†·â£·àç</span>
            <div class="flex flex-col items-end mt-1">
                <span id="headerLevel" class="text-[10px] font-black uppercase tracking-tighter tier-basic">·àò·à†·à®·â≥·ãä</span>
                <span id="memberId" class="text-[10px] font-bold opacity-50 uppercase tracking-widest">ID: #---</span>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-5 pb-24">
        <nav class="nav-container grid grid-cols-4 mb-10">
            <button onclick="showTab('payment')" id="paymentTab" class="nav-btn py-4 active-tab">·ä≠·çç·ã´</button>
            <button onclick="showTab('status')" id="statusTab" class="nav-btn py-4">·àÅ·äî·â≥</button>
            <button onclick="showTab('loan')" id="loanTab" class="nav-btn py-4">·â•·ãµ·à≠</button>
            <button onclick="showTab('help')" id="helpTab" class="nav-btn py-4">·ä•·à≠·ã≥·â≥</button>
        </nav>

        <!-- 1. Payment Section -->
        <section id="paymentSection" class="animate-section space-y-8">
            <div class="space-y-4">
                <h3 class="text-xs font-black uppercase opacity-60 tracking-[0.2em] ml-1">·ã®·ä≠·çç·ã´ ·àù·à≠·å´</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div id="manualBtn" class="method-card p-7 rounded-[2rem] flex flex-col items-center gap-3 selected" onclick="selectPaymentMode('manual')">
                        <span class="text-4xl">üßæ</span>
                        <span class="text-xs font-black uppercase tracking-wider">·â†·ã∞·à®·à∞·äù</span>
                    </div>
                    <div id="easypayBtn" class="method-card p-7 rounded-[2rem] flex flex-col items-center gap-3" onclick="selectPaymentMode('easypay')">
                        <span class="text-4xl">üí≥</span>
                        <span class="text-xs font-black uppercase tracking-wider">·âÄ·àã·àç ·ä≠·çç·ã´</span>
                    </div>
                </div>
            </div>

            <!-- Gateway Selector -->
            <div id="gatewaySelector" class="hidden section-card p-6 space-y-5">
                <h3 class="text-xs font-black uppercase opacity-50 text-center tracking-widest">·àò·â∞·åç·â†·à™·ã´ ·ã≠·àù·à®·å°</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="gateway-pill p-4 rounded-2xl flex flex-col items-center selected" onclick="selectGateway('chapa', this)">
                        <img src="Chapa.png" class="w-12 h-12 mb-2 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=C&background=000&color=fff'">
                        <span class="text-[10px] font-black uppercase">Chapa</span>
                    </div>
                    <div class="gateway-pill p-4 rounded-2xl flex flex-col items-center" onclick="selectGateway('telebirr', this)">
                        <img src="Telebirr.png" class="w-12 h-12 mb-2 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=T&background=0052cc&color=fff'">
                        <span class="text-[10px] font-black uppercase">Telebirr</span>
                    </div>
                    <div class="gateway-pill p-4 rounded-2xl flex flex-col items-center" onclick="selectGateway('cbe', this)">
                        <img src="Cbe.png" class="w-12 h-12 mb-2 rounded-lg object-contain" onerror="this.src='https://ui-avatars.com/api/?name=E&background=6a1b9a&color=fff'">
                        <span class="text-[10px] font-black uppercase">CBE Birr</span>
                    </div>
                </div>
            </div>

            <form id="paymentForm" class="space-y-6">
                <div class="section-card p-7 space-y-7">
                    <div class="space-y-2">
                        <label class="text-[11px] font-black uppercase opacity-50 ml-1">·ã®·ä≠·çç·ã´ ·ãì·ã≠·äê·âµ</label>
                        <select id="paymentType" class="input-style font-black text-base" onchange="updatePenalty()">
                            <option value="·àò·ã∞·â†·äõ ·àò·ãã·åÆ">·àò·ã∞·â†·äõ ·àò·ãã·åÆ</option>
                            <option value="·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª">·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª</option>
                            <option value="·ã®·âÖ·å£·âµ ·ä≠·çç·ã´">·ã®·âÖ·å£·âµ ·ä≠·çç·ã´</option>
                            <option value="·àå·àã">·àå·àã</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-black uppercase opacity-50 ml-1">·ã®·ä≠·çç·ã´ ·âÄ·äï (·ãõ·à¨ - ·ã®·àõ·ã≠·âÄ·ã®·à≠)</label>
                        <div class="grid grid-cols-3 gap-3">
                            <select id="month" disabled class="input-style font-black text-xs px-2 bg-slate-100 border-none">
                                <option value="·ã®·ä´·â≤·âµ">·ã®·ä´·â≤·âµ</option>
                            </select>
                            <select id="day" disabled class="input-style font-black text-xs px-2 bg-slate-100 border-none">
                                <option value="17">17</option>
                            </select>
                            <select id="year" disabled class="input-style font-black text-xs px-2 bg-slate-100 border-none">
                                <option value="2018">2018</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-[11px] font-black uppercase opacity-50 ml-1">·àò·å†·äï (·â•·à≠)</label>
                            <input type="number" id="amount" placeholder="0.00" required class="input-style font-black text-green-700">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-black uppercase opacity-50 ml-1">·âÖ·å£·âµ (·â•·à≠)</label>
                            <input type="number" id="penalty" value="0" readonly class="input-style font-black text-red-600 bg-slate-50">
                        </div>
                    </div>
                </div>

                <div id="receiptWrapper" class="section-card p-7 space-y-4">
                    <label class="text-[11px] font-black uppercase opacity-50 ml-1">·ã®·ã∞·à®·à∞·äù ·çé·â∂ (Receipt)</label>
                    <div class="relative w-full aspect-video bg-black/5 rounded-3xl border-2 border-dashed border-black/10 flex flex-col items-center justify-center overflow-hidden transition-all hover:bg-black/10" onclick="document.getElementById('receiptInput').click()">
                        <div id="uploadPlaceholder" class="text-center">
                            <span class="text-4xl block mb-3">üì∏</span>
                            <span class="text-xs font-black opacity-50 uppercase tracking-widest">·àà·àò·å´·äï ·ã≠·äï·ä©</span>
                        </div>
                        <input type="file" id="receiptInput" accept="image/*" class="hidden" onchange="handlePreview(this)">
                        <img id="receiptPreview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                </div>

                <button type="submit" id="submitBtn" class="w-full py-6 bg-green-700 text-white rounded-[2rem] font-black text-xl shadow-2xl shadow-green-900/20 flex items-center justify-center gap-4 active:scale-95 transition-all">
                    <span id="btnText">·àò·à®·åÉ·ãç·äï ·àã·ä≠</span>
                </button>
            </form>
        </section>

        <!-- 2. Status Section -->
        <section id="statusSection" class="hidden animate-section space-y-8">
            <div class="bg-slate-900 p-10 rounded-[2.5rem] shadow-2xl relative overflow-hidden text-white">
                <div class="absolute -right-10 -top-10 w-48 h-48 bg-green-500/10 rounded-full blur-3xl"></div>
                <div class="space-y-2 text-center">
                    <p class="text-[11px] font-black uppercase tracking-[0.3em] opacity-50">·å†·âÖ·àã·àã ·ã®·â∞·ä®·çà·àà ·àÇ·à≥·â•</p>
                    <h2 class="text-6xl font-black tracking-tight"><span id="totalBalance">0.00</span> <span class="text-sm opacity-50 ml-1">·â•·à≠</span></h2>
                </div>
                <div class="mt-10 bg-white/5 p-6 rounded-[1.75rem] border border-white/10 flex justify-between items-center">
                    <div>
                        <p class="text-[11px] font-black uppercase opacity-60 mb-1">·ã®·âÄ·à® ·ãï·ã≥</p>
                        <h3 class="text-3xl font-black text-red-400"><span id="remainingBalance">0.00</span> <span class="text-xs opacity-50">·â•·à≠</span></h3>
                    </div>
                    <div class="text-right">
                        <p class="text-[11px] font-black uppercase opacity-50 mb-1">·ã∞·à®·åÉ</p>
                        <p id="memberLevelDisplay" class="text-sm font-black uppercase tier-basic">·àò·à†·à®·â≥·ãä</p>
                    </div>
                </div>
            </div>

            <!-- Tier Rules Info -->
            <div class="section-card p-7 space-y-5">
                <h4 class="text-xs font-black uppercase opacity-50 tracking-widest text-center">·ã®·ä†·â£·àç·äê·âµ ·ã∞·à®·åÉ·ãé·âΩ ·àò·àµ·çà·à≠·â∂·âΩ</h4>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div>
                            <span class="tier-basic text-xs uppercase block">·àò·à†·à®·â≥·ãä</span>
                            <span class="text-[10px] font-bold opacity-50">·ã®·àò·åÄ·àò·à™·ã´ ·ã∞·à®·åÉ</span>
                        </div>
                        <span class="text-xs font-bold opacity-40">0 - 1.5k</span>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-blue-50/50 rounded-2xl border border-blue-100">
                        <div>
                            <span class="tier-pro text-xs uppercase block">·çï·àÆ (Pro)</span>
                            <span class="text-[10px] font-bold text-blue-600">1,500 ·â•·à≠ + 5 ·â∞·à≥·âµ·çé</span>
                        </div>
                        <span class="text-xs font-bold text-blue-400">1.5k - 5k</span>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-amber-50/50 rounded-2xl border border-amber-100">
                        <div>
                            <span class="tier-elite text-xs uppercase block">·àç·ã© (Elite)</span>
                            <span class="text-[10px] font-bold text-amber-600">5,000 ·â•·à≠ + 12 ·â∞·à≥·âµ·çé</span>
                        </div>
                        <span class="text-xs font-bold text-amber-400">5k+</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-5">
                <div class="section-card p-7 flex flex-col items-center">
                    <span class="text-3xl block mb-3">üìÖ</span>
                    <p class="text-xs font-black opacity-50 uppercase tracking-widest mb-1">·àò·ãã·åÆ</p>
                    <p class="text-2xl font-black"><span id="sumMonthly">0.00</span></p>
                </div>
                <div class="section-card p-7 flex flex-col items-center">
                    <span class="text-3xl block mb-3">‚úÖ</span>
                    <p class="text-xs font-black opacity-50 uppercase tracking-widest mb-1">·â∞·à≥·âµ·çé</p>
                    <p class="text-2xl font-black text-green-600"><span id="approvedCount">0</span></p>
                </div>
            </div>

            <div class="space-y-5">
                <h4 class="text-xs font-black uppercase opacity-60 tracking-[0.3em] px-2">·ã®·âÖ·à≠·â• ·åä·ãú ·ä•·äï·âÖ·àµ·âÉ·à¥·ãé·âΩ</h4>
                <div id="transactionList" class="space-y-4">
                    <!-- Transactions -->
                </div>
            </div>
        </section>

        <!-- 3. Loan Section -->
        <section id="loanSection" class="hidden animate-section space-y-6">
            <div class="section-card p-10 text-center bg-slate-900 text-white relative overflow-hidden loan-glow">
                <div class="w-24 h-24 bg-brand-green rounded-[2.5rem] flex items-center justify-center text-5xl mx-auto mb-6 shadow-2xl">üè¶</div>
                <h3 class="text-2xl font-black uppercase">·ã®·â•·ãµ·à≠ ·ä†·åà·àç·åç·àé·âµ</h3>
                <div class="mt-5 flex items-center justify-center gap-2">
                    <span class="w-3 h-3 bg-yellow-400 rounded-full animate-ping"></span>
                    <p class="text-xs font-black uppercase text-yellow-400">·â†·åç·äï·â£·â≥ ·àã·ã≠</p>
                </div>
                <p class="text-xs font-bold text-slate-400 mt-5 leading-relaxed">·ä†·åà·àç·åç·àé·â± ·à≤·åÄ·àù·à≠ ·ã®·çï·àÆ ·ä•·äì ·ã®·àç·ã© ·ä†·â£·àã·âµ ·âÖ·ãµ·àö·ã´ ·ã®·àõ·åç·äò·âµ ·ãï·ãµ·àç ·ã≠·äñ·à´·â∏·ãã·àç·ç¢</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="section-card p-6 bg-slate-50/50 locked-feature">
                    <div class="locked-badge">·â†·âÖ·à≠·â°</div>
                    <span class="text-3xl block mb-3">üìâ</span>
                    <p class="text-xs font-black uppercase">·ãù·âÖ·â∞·äõ ·ãà·àà·ãµ</p>
                </div>
                <div class="section-card p-6 bg-slate-50/50 locked-feature">
                    <div class="locked-badge">·â†·âÖ·à≠·â°</div>
                    <span class="text-3xl block mb-3">ü§ù</span>
                    <p class="text-xs font-black uppercase">·ãã·àµ·âµ·äì</p>
                </div>
            </div>
        </section>

        <!-- 4. Help Section -->
        <section id="helpSection" class="hidden animate-section py-5 space-y-6">
            <div class="section-card p-8 space-y-6">
                <h4 class="text-base font-black uppercase border-b border-black/5 pb-4">·àò·àò·à™·ã´·ãé·âΩ</h4>
                <div class="space-y-5 text-sm font-semibold text-slate-600 leading-relaxed">
                    <div class="flex gap-4">
                        <span class="w-8 h-8 bg-green-100 text-green-700 rounded-lg flex items-center justify-center font-black flex-shrink-0">1</span>
                        <p>·â†·àò·åÄ·àò·à™·ã´ ·ã®·ä≠·çç·ã´ ·åà·åΩ ·àã·ã≠ ·â†·àò·åç·â£·âµ ·ã®·ä≠·çç·ã´·ãé·äï ·àò·à®·åÉ ·â†·âµ·ä≠·ä≠·àç ·ã≠·àô·àâ::</p>
                    </div>
                    <div class="flex gap-4">
                        <span class="w-8 h-8 bg-green-100 text-green-700 rounded-lg flex items-center justify-center font-black flex-shrink-0">2</span>
                        <p>·â†·ã∞·à®·à∞·äù ·ä≠·çç·ã´ ·à≤·çà·åΩ·àô ·ã®·â£·äï·ä≠ ·ã∞·à®·à∞·äô·äï ·çé·â∂ ·â†·âµ·ä≠·ä≠·àç ·àò·å´·äï·ãé·äï ·ã´·à®·åã·åç·å°::</p>
                    </div>
                </div>
            </div>
            <a href="https://t.me/Abiym" target="_blank" class="block bg-blue-600/10 border border-blue-600/20 p-8 rounded-[2.5rem] flex items-center justify-between active:scale-95 transition-all">
                <div class="flex items-center gap-6">
                    <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white text-3xl shadow-xl">üí¨</div>
                    <div>
                        <h4 class="text-sm font-black text-blue-900 uppercase">·ä•·à≠·ã≥·â≥ ·ã≠·çà·àç·åã·àâ?</h4>
                        <p class="text-xs font-bold text-blue-700/60 mt-1">·ä†·àµ·â∞·ã≥·ã≥·à™·ãç·äï ·ã´·äê·åã·åç·à©</p>
                    </div>
                </div>
                <span class="text-blue-600 text-xl font-black">‚Üí</span>
            </a>
        </section>

        <footer class="mt-12 text-center opacity-20">
            <p class="text-[10px] font-black uppercase tracking-[0.4em]">Edir Digital v3.6 ‚Ä¢ SkyMark</p>
        </footer>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State
        window.paymentMode = 'manual';
        window.selectedGateway = 'chapa';
        window.currentUser = null;
        const MONTHLY_FEE = 100;

        // UI Logic
        window.showTab = (t) => {
            ['payment', 'status', 'loan', 'help'].forEach(s => {
                document.getElementById(s+'Section')?.classList.add('hidden');
                document.getElementById(s+'Tab')?.classList.remove('active-tab');
            });
            document.getElementById(t+'Section')?.classList.remove('hidden');
            document.getElementById(t+'Tab')?.classList.add('active-tab');
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.selectPaymentMode = (mode) => {
            window.paymentMode = mode;
            document.getElementById('manualBtn').classList.toggle('selected', mode === 'manual');
            document.getElementById('easypayBtn').classList.toggle('selected', mode === 'easypay');
            document.getElementById('gatewaySelector').classList.toggle('hidden', mode === 'manual');
            document.getElementById('receiptWrapper').classList.toggle('hidden', mode === 'easypay');
            document.getElementById('btnText').innerText = mode === 'manual' ? '·àò·à®·åÉ·ãç·äï ·àã·ä≠' : '·àà·àò·ä≠·çà·àç ·âÄ·å•·àç';
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.selectionChanged();
        };

        window.selectGateway = (gateway, el) => {
            window.selectedGateway = gateway;
            document.querySelectorAll('.gateway-pill').forEach(p => p.classList.remove('selected'));
            el.classList.add('selected');
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.selectionChanged();
        };

        window.updatePenalty = () => {
            const day = 17; // Mocked today day
            const type = document.getElementById('paymentType').value;
            const penaltyInput = document.getElementById('penalty');
            if (type === '·àò·ã∞·â†·äõ ·àò·ãã·åÆ') {
                if (day >= 1 && day <= 5) penaltyInput.value = 0;
                else if (day >= 6 && day <= 10) penaltyInput.value = 20;
                else penaltyInput.value = 50;
            } else penaltyInput.value = 0;
        };

        // Firebase Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'edir-pro-v3';

        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                setupDataListeners(user.uid);
                const u = tg.initDataUnsafe?.user;
                if (u) {
                    document.getElementById('userName').innerText = [u.first_name, u.last_name].filter(Boolean).join(' ') || "·ä†·â£·àç";
                    document.getElementById('memberId').innerText = `ID: #${u.id.toString().slice(-4)}`;
                }
                window.updatePenalty();
            }
        });

        initAuth();

        function updateTierUI(total, count) {
            let level = "·àò·à†·à®·â≥·ãä";
            let cls = "tier-basic";
            if (total > 5000 && count >= 12) { level = "·àç·ã© (Elite)"; cls = "tier-elite"; }
            else if (total > 1500 && count >= 5) { level = "·çï·àÆ (Pro)"; cls = "tier-pro"; }
            
            const hl = document.getElementById('headerLevel');
            const ml = document.getElementById('memberLevelDisplay');
            if(hl) { hl.innerText = level; hl.className = `text-[10px] font-black uppercase tracking-tighter ${cls}`; }
            if(ml) { ml.innerText = level; ml.className = `text-sm font-black uppercase ${cls}`; }
        }

        function setupDataListeners(uid) {
            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'payments'), (snap) => {
                const list = document.getElementById('transactionList');
                if (!list) return;

                const mockExample = `
                    <div class="status-pill p-6 rounded-3xl flex items-center justify-between border-2 border-dashed border-green-200 bg-green-50/30">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-2xl shadow-sm">üìÖ</div>
                            <div>
                                <p class="text-sm font-black text-slate-800">·àù·à≥·àå·ç¶ ·àò·ã∞·â†·äõ ·àò·ãã·åÆ</p>
                                <p class="text-[11px] font-bold text-green-600 uppercase mt-0.5">·âÄ·àã·àç ·ä≠·çç·ã´ ‚Ä¢ ·ã®·ä´·â≤·âµ 17</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-base font-black">100 ·â•·à≠</p>
                            <span class="text-[10px] font-black px-3 py-1 rounded-full text-green-600 bg-green-100 border border-green-200">·å∏·ãµ·âã·àç ‚úÖ</span>
                        </div>
                    </div>`;

                if (snap.empty) {
                    list.innerHTML = `<p class="text-[11px] font-bold opacity-30 uppercase tracking-widest text-center mb-4">·àù·äï·àù ·àò·à®·åÉ ·ã®·àà·àù (·àù·à≥·àå ·â≥·à™·ä≠)</p>${mockExample}`;
                    document.getElementById('remainingBalance').innerText = "100.00";
                    updateTierUI(0, 0);
                    return;
                }

                let h = '', m = 0, p = 0, t = 0, count = 0, pend = false;
                snap.docs.map(d => ({id: d.id, ...d.data()}))
                         .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
                         .forEach(tx => {
                            const status = tx.status || 'AWAIT_APPROVAL';
                            if (status === 'AWAIT_APPROVAL') pend = true;
                            if (status === 'APPROVED') {
                                count++;
                                t += (tx.totalAmount || 0);
                                if (tx.purpose?.includes('·àò·ãã·åÆ')) m += (tx.baseAmount || tx.totalAmount || 0);
                                p += (tx.penaltyAmount || 0);
                            }
                            const clr = status === 'APPROVED' ? 'text-green-600 bg-green-50' : (status === 'REJECTED' ? 'text-red-600 bg-red-50' : 'text-orange-600 bg-orange-50');
                            const icon = tx.purpose?.includes('·àò·ãã·åÆ') ? 'üìÖ' : 'üí∞';
                            h += `
                                <div class="status-pill p-6 rounded-3xl flex items-center justify-between shadow-sm bg-white border border-slate-100">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-2xl shadow-inner">${icon}</div>
                                        <div>
                                            <p class="text-sm font-black text-slate-800">${tx.purpose || '·ä≠·çç·ã´'}</p>
                                            <p class="text-[11px] font-bold opacity-40 uppercase mt-0.5">${tx.gateway?.toUpperCase() || 'MANUAL'} ‚Ä¢ ${new Date((tx.timestamp?.seconds||0)*1000).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-base font-black">${tx.totalAmount || 0} ·â•·à≠</p>
                                        <span class="text-[10px] font-black px-3 py-1 rounded-full ${clr}">${status === 'APPROVED' ? '·å∏·ãµ·âã·àç' : (status === 'REJECTED' ? '·ãç·ãµ·âÖ' : '·â†·àò·å†·â£·â†·âÖ')}</span>
                                    </div>
                                </div>`;
                         });

                list.innerHTML = h;
                document.getElementById('sumMonthly').innerText = m.toLocaleString();
                document.getElementById('approvedCount').innerText = count;
                document.getElementById('totalBalance').innerText = t.toLocaleString();
                document.getElementById('remainingBalance').innerText = Math.max(0, MONTHLY_FEE - m).toLocaleString();
                document.getElementById('pendingAlert')?.classList.toggle('hidden', !pend);
                updateTierUI(t, count);
            });
        }

        window.handlePreview = (i) => {
            if (i.files[0]) {
                const r = new FileReader();
                r.onload = (e) => {
                    const pr = document.getElementById('receiptPreview');
                    const ph = document.getElementById('uploadPlaceholder');
                    if(pr) { pr.src = e.target.result; pr.classList.remove('hidden'); }
                    if(ph) ph.classList.add('hidden');
                };
                r.readAsDataURL(i.files[0]);
            }
        };

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!window.currentUser) return;
            const amt = parseFloat(document.getElementById('amount').value) || 0;
            const pen = parseFloat(document.getElementById('penalty').value) || 0;
            const purpose = `${document.getElementById('paymentType').value}: ·ã®·ä´·â≤·âµ 17, 2018`;

            if (window.paymentMode === 'easypay') {
                if (tg.MainButton) { tg.MainButton.setText("·ä≠·çç·ã´ ·â†·àò·åÄ·àò·à≠ ·àã·ã≠..."); tg.MainButton.show(); tg.MainButton.showProgress(); }
                const payload = { type: 'payment_report', gateway: window.selectedGateway, purpose: purpose, totalAmount: amt + pen, isDigital: true, tx_ref: `TX-${Date.now()}` };
                await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'payments'), { ...payload, status: 'AWAIT_APPROVAL', timestamp: serverTimestamp() });
                tg.sendData(JSON.stringify(payload));
                setTimeout(() => tg.close(), 2000);
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<div class="loader"></div>'; btn.disabled = true;
            const payload = { type: 'payment_report', gateway: 'manual', purpose: purpose, baseAmount: amt, penaltyAmount: pen, totalAmount: amt + pen, timestamp: serverTimestamp() };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'payments'), { ...payload, status: 'AWAIT_APPROVAL' });
                tg.sendData(JSON.stringify(payload));
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => tg.close(), 1000);
            } catch (err) { btn.innerHTML = '·àµ·àÖ·â∞·âµ ·â∞·çà·å•·àØ·àç'; btn.disabled = false; }
        });
    </script>
</body>
</html>
