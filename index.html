<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠ - Edir Digital Pro</title>
    <!-- SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@100..900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f1f5f9);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #0f172a);
            --brand-green: #15803d;
            --brand-light: rgba(21, 128, 61, 0.08);
            --card-border: rgba(226, 232, 240, 0.8);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tg-bg: var(--tg-theme-bg-color, #0f172a);
                --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #1e293b);
                --tg-text: var(--tg-theme-text-color, #f8fafc);
                --card-border: rgba(51, 65, 85, 0.5);
            }
        }

        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: 'Noto Sans Ethiopic', 'Inter', sans-serif;
            margin: 0; padding: 0;
            overflow: hidden;
        }

        /* --- LOADING ANIMATION --- */
        #appLoader {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, var(--tg-secondary-bg) 0%, var(--tg-bg) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.8s;
        }

        .loader-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader-ring {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--brand-green);
            border-bottom-color: var(--brand-green);
            animation: spin 2s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .loader-logo {
            width: 100px; height: 100px; border-radius: 2.5rem;
            background: white; padding: 5px; shadow: 0 15px 35px rgba(0,0,0,0.1);
            z-index: 10; animation: breathe 3s ease-in-out infinite;
        }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }

        .loader-info { margin-top: 40px; text-align: center; }
        .progress-track { width: 180px; height: 4px; background: var(--card-border); border-radius: 10px; overflow: hidden; position: relative; }
        .progress-fill { position: absolute; height: 100%; width: 40%; background: var(--brand-green); animation: loading-progress 2s infinite ease-in-out; }
        @keyframes loading-progress { 0% { left: -40%; width: 30%; } 50% { width: 60%; } 100% { left: 110%; width: 30%; } }

        /* --- MAIN CONTENT --- */
        #mainContent { opacity: 0; transform: translateY(20px); transition: all 0.6s ease-out; }
        #mainContent.visible { opacity: 1; transform: translateY(0); }

        .section-card {
            background-color: var(--tg-secondary-bg);
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            padding: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .input-style {
            background-color: var(--tg-bg);
            border: 2px solid var(--card-border);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 15px;
            color: var(--tg-text);
            outline: none;
            transition: all 0.2s;
        }
        .input-style:focus { border-color: var(--brand-green); }

        .method-card {
            border: 2px solid var(--card-border);
            border-radius: 1.25rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--tg-secondary-bg);
        }
        .method-card.selected { border-color: var(--brand-green); background-color: var(--brand-light); }

        .tab-btn { padding: 12px 4px; border-radius: 0.75rem; font-weight: 700; font-size: 11px; opacity: 0.6; transition: 0.3s; }
        .active-tab { color: var(--brand-green) !important; background: var(--tg-secondary-bg) !important; opacity: 1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        #notificationCenter {
            position: fixed;
            top: 0; right: -100%;
            width: 85%; height: 100%;
            background: var(--tg-secondary-bg);
            z-index: 1000;
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            transition: 0.4s ease;
            padding: 1.5rem;
        }
        #notificationCenter.open { right: 0; }

        .gateway-pill { border: 1px solid var(--card-border); border-radius: 0.75rem; padding: 0.5rem; text-align: center; cursor: pointer; transition: 0.2s; }
        .gateway-pill.selected { border-color: var(--brand-green); background: var(--brand-light); }
        .gateway-logo { width: 30px; height: 30px; border-radius: 6px; margin: 0 auto 4px; }

        .animate-section { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 pb-10">

    <!-- LOADING SCREEN -->
    <div id="appLoader">
        <div class="loader-wrapper">
            <div class="loader-ring"></div>
            <img src="logo.PNG" alt="Logo" class="loader-logo" onerror="this.src='https://ui-avatars.com/api/?name=EP&background=15803d&color=fff&size=128'">
        </div>
        <div class="loader-info">
            <div class="loader-text">·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠...</div>
            <div class="progress-track"><div class="progress-fill"></div></div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="mainContent">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-700 rounded-2xl flex items-center justify-center shadow-lg overflow-hidden">
                    <img src="logo.PNG" alt="Logo" class="w-full h-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=EP&background=15803d&color=fff&size=64'">
                </div>
                <div>
                    <h1 id="userFullName" class="text-lg font-black leading-tight">·ä•·àÅ·ãµ·äï ·â†·çç·âÖ·à≠</h1>
                    <p class="text-[9px] font-bold opacity-40 uppercase">@Abiymersha</p>
                </div>
            </div>
            <button onclick="toggleNotif()" class="relative w-10 h-10 bg-black/5 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <div id="notifBadge" class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full border border-white"></div>
            </button>
        </header>

        <!-- NAVIGATION -->
        <nav id="mainNav" class="bg-black/5 p-1 rounded-2xl grid grid-cols-4 gap-1 mb-6 shadow-sm">
            <button onclick="showTab('payment')" id="payTab" class="tab-btn active-tab">·ä≠·çç·ã´</button>
            <button onclick="showTab('status')" id="statTab" class="tab-btn">·àÅ·äî·â≥</button>
            <button onclick="showTab('loan')" id="loanTab" class="tab-btn">·â•·ãµ·à≠</button>
            <button onclick="showTab('help')" id="helpTab" class="tab-btn">·ä•·à≠·ã≥·â≥</button>
        </nav>

        <!-- SECTION: PAYMENT (RESTORED) -->
        <div id="paymentSection" class="animate-section space-y-5">
            <form id="paymentForm" class="space-y-5">
                <div class="section-card space-y-4">
                    <h3 class="text-[10px] font-black uppercase opacity-40 px-1">·ä≠·çç·ã´·ãç ·àà·àõ·äï ·äê·ãç?</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div id="selfPay" class="method-card selected" onclick="togglePayer('self')">üôã‚Äç‚ôÇÔ∏è <span class="text-[11px] font-black uppercase block mt-1">·àà·ä•·äî</span></div>
                        <div id="otherPay" class="method-card" onclick="togglePayer('other')">üë• <span class="text-[11px] font-black uppercase block mt-1">·àà·àå·àã</span></div>
                    </div>
                    <div id="otherMemberBox" class="hidden mt-2">
                        <input type="text" id="targetMember" placeholder="@username ·ãà·ã≠·àù ·àô·àâ ·àµ·àù" class="input-style text-sm">
                    </div>
                </div>

                <div class="section-card space-y-5">
                    <div>
                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">·ã®·ä≠·çç·ã´ ·ãì·ã≠·äê·âµ</label>
                        <select id="purpose" class="input-style mt-1 text-sm font-bold" onchange="handleTypeChange(); autoCalculatePenalty();">
                            <option value="·àò·ã∞·â†·äõ ·àò·ãã·åÆ">·àò·ã∞·â†·äõ ·àò·ãã·åÆ</option>
                            <option value="·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª">·ã®·â•·ãµ·à≠ ·àò·àò·àà·àª</option>
                            <option value="·ã®·âÖ·å£·âµ ·ä≠·çç·ã´">·ã®·âÖ·å£·âµ ·ä≠·çç·ã´</option>
                            <option value="·àå·àã ·ä≠·çç·ã´">·àå·àã ·ä≠·çç·ã´</option>
                        </select>
                    </div>
                    <div>
                        <label id="periodLabel" class="text-[10px] font-black uppercase opacity-40 ml-1">·ã®·ä≠·çç·ã´ ·åä·ãú</label>
                        <div id="dateGrid" class="grid grid-cols-3 gap-2 mt-1">
                            <select id="periodMonth" class="input-style text-xs font-bold" onchange="autoCalculatePenalty()"></select>
                            <select id="periodDay" class="input-style text-xs font-bold" onchange="autoCalculatePenalty()"></select>
                            <select id="periodYear" class="input-style text-xs font-bold"></select>
                        </div>
                        <select id="periodOther" class="input-style mt-1 text-sm hidden">
                            <option value="·ãà·ã∞ ·ãï·ãµ·à≠ ·ä†·ä´·ãç·äï·âµ">·ãà·ã∞ ·ãï·ãµ·à≠ ·ä†·ä´·ãç·äï·âµ</option>
                            <option value="·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ">·ãà·ã∞ ·àå·àã ·ä†·â£·àç ·ä†·ä´·ãç·äï·âµ</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-black uppercase opacity-40 ml-1">·àò·å†·äï (·â•·à≠)</label>
                            <input type="number" id="amount" placeholder="0.00" required class="input-style mt-1 text-lg font-black text-green-700">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase opacity-40 ml-1">·âÖ·å£·âµ</label>
                            <input type="number" id="penalty" value="0" class="input-style mt-1 text-lg font-black text-red-600">
                            <p id="penaltyHint" class="text-[8px] font-bold text-red-500 mt-1 ml-1"></p>
                        </div>
                    </div>
                </div>

                <div class="section-card space-y-4">
                    <div class="flex justify-between items-center px-1">
                        <h3 class="text-[10px] font-black uppercase opacity-40">·ã®·ä≠·çç·ã´ ·àò·äï·åà·ãµ</h3>
                        <p id="restrictionNote" class="text-[8px] font-black text-red-500 hidden">·àà·ä†·â£·àç ·â†·ã∞·à®·à∞·äù ·â•·âª!</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div id="mManual" class="method-card selected py-4" onclick="setMode('manual')">üßæ ·â†·ã∞·à®·à∞·äù</div>
                        <div id="mEasy" class="method-card py-4" onclick="setMode('easypay')">üí≥ ·ã≤·åÇ·â≥·àç</div>
                    </div>

                    <div id="digitalGateways" class="hidden grid grid-cols-3 gap-2 mt-2 pt-2 border-t border-black/5">
                        <div class="gateway-pill selected" onclick="selectGateway('chapa', this)">
                            <img src="https://ui-avatars.com/api/?name=C&background=15803d&color=fff" class="gateway-logo">
                            <span class="text-[9px] font-black">Chapa</span>
                        </div>
                        <div class="gateway-pill" onclick="selectGateway('telebirr', this)">
                            <img src="https://ui-avatars.com/api/?name=T&background=0052cc&color=fff" class="gateway-logo">
                            <span class="text-[9px] font-black">Telebirr</span>
                        </div>
                        <div class="gateway-pill" onclick="selectGateway('cbe', this)">
                            <img src="https://ui-avatars.com/api/?name=B&background=6a1b9a&color=fff" class="gateway-logo">
                            <span class="text-[9px] font-black">CBE Birr</span>
                        </div>
                    </div>

                    <div id="receiptUploadArea" class="mt-2 pt-2 border-t border-black/5 text-center">
                        <div class="bg-black/5 border-dashed border-2 border-slate-300 p-6 rounded-2xl" onclick="document.getElementById('receiptFile').click()">
                            <div id="uploadPlaceholder">üì∏ <span class="text-[10px] font-black uppercase opacity-60">·ã∞·à®·à∞·äù ·ã≠·å´·äë</span></div>
                            <img id="previewImage" class="hidden mx-auto max-h-40 rounded-lg shadow-md mt-2">
                        </div>
                        <input type="file" id="receiptFile" class="hidden" accept="image/*" onchange="previewReceipt(this)">
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-green-700 text-white rounded-2xl font-black shadow-lg hover:bg-green-800 active:scale-95 transition-all">·àò·à®·åÉ·ãç·äï ·àã·ä≠</button>
            </form>
        </div>

        <div id="statusSection" class="hidden animate-section space-y-5">
            <div class="section-card bg-slate-900 text-white p-6 relative overflow-hidden">
                <p class="text-[10px] font-bold uppercase opacity-50 text-green-400">·å†·âÖ·àã·àã ·âÅ·å†·â£</p>
                <h2 class="text-4xl font-black">2,450.00 ·â•·à≠</h2>
            </div>
        </div>

        <!-- Notification Drawer -->
        <div id="notificationCenter">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-black">·àõ·à≥·ãà·âÇ·ã´·ãé·âΩ</h2>
                <button onclick="toggleNotif()" class="text-xs font-bold opacity-50 uppercase">·ãù·åã</button>
            </div>
            <div id="notifList" class="space-y-3">
                <div class="p-4 rounded-xl bg-green-50 border-l-4 border-green-500">
                    <p class="text-[11px] font-bold text-green-800 uppercase mb-1">·ä•·äï·ä≥·äï ·ã∞·àÖ·äì ·àò·å°</p>
                    <p class="text-[10px] opacity-70">·àò·â∞·åç·â†·à™·ã´·ãç·äï ·àò·å†·âÄ·àù ·àµ·àà·åÄ·àò·à© ·ä•·äì·àò·à∞·åç·äì·àà·äï·ç¢</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let payerMode = 'self';
        let payMode = 'manual';
        let digitalGateway = 'chapa';

        const months = ["·àò·àµ·ä®·à®·àù", "·å•·âÖ·àù·âµ", "·àÖ·ã≥·à≠", "·â≥·àÖ·à≥·àµ", "·å•·à≠", "·ã®·ä´·â≤·âµ", "·àò·åã·â¢·âµ", "·àö·ã´·ãù·ã´", "·åç·äï·â¶·âµ", "·à∞·äî", "·àê·àù·àå", "·äê·àê·à¥"];
        const currentYear = 2017;

        window.onload = function() {
            setTimeout(() => {
                document.getElementById('appLoader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('appLoader').style.display = 'none';
                    document.getElementById('mainContent').classList.add('visible');
                    document.body.style.overflow = 'auto';
                }, 800);
            }, 2000);
        };

        function populateDateSelectors() {
            const mSelect = document.getElementById('periodMonth');
            const dSelect = document.getElementById('periodDay');
            const ySelect = document.getElementById('periodYear');
            if(!mSelect || !dSelect || !ySelect) return;
            mSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
            let days = "";
            for(let i=1; i<=30; i++) days += `<option value="${i}">${i}</option>`;
            dSelect.innerHTML = days;
            ySelect.innerHTML = `<option value="${currentYear-1}">${currentYear-1}</option><option value="${currentYear}" selected>${currentYear}</option><option value="${currentYear+1}">${currentYear+1}</option>`;
        }

        window.showTab = (tabName) => {
            ['payment', 'status', 'loan', 'help'].forEach(s => {
                const sec = document.getElementById(s + 'Section');
                const tab = document.getElementById(s + 'Tab');
                if(sec) sec.classList.toggle('hidden', s !== tabName);
                if(tab) tab.classList.toggle('active-tab', s === tabName);
            });
            tg.HapticFeedback.impactOccurred('light');
        };

        window.toggleNotif = () => {
            document.getElementById('notificationCenter').classList.toggle('open');
            document.getElementById('notifBadge').classList.add('hidden');
        };

        window.togglePayer = (mode) => {
            payerMode = mode;
            document.getElementById('selfPay').classList.toggle('selected', mode === 'self');
            document.getElementById('otherPay').classList.toggle('selected', mode === 'other');
            document.getElementById('otherMemberBox').classList.toggle('hidden', mode === 'self');
        };

        window.setMode = (m) => {
            if (m === 'easypay' && payerMode === 'other') {
                tg.showAlert("·àà·àå·àã ·ä†·â£·àç ·â†·ã∞·à®·à∞·äù ·â•·âª ·äê·ãç ·àò·ä≠·çà·àç ·ã®·àö·âª·àà·ãç!");
                return;
            }
            payMode = m;
            document.getElementById('mManual').classList.toggle('selected', m === 'manual');
            document.getElementById('mEasy').classList.toggle('selected', m === 'easypay');
            document.getElementById('receiptUploadArea').classList.toggle('hidden', m !== 'manual');
            document.getElementById('digitalGateways').classList.toggle('hidden', m !== 'easypay');
        };

        window.selectGateway = (gw, el) => {
            digitalGateway = gw;
            document.querySelectorAll('.gateway-pill').forEach(p => p.classList.remove('selected'));
            el.classList.add('selected');
        };

        window.previewReceipt = (input) => {
            const preview = document.getElementById('previewImage');
            const placeholder = document.getElementById('uploadPlaceholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if(preview) { preview.src = e.target.result; preview.classList.remove('hidden'); }
                    if(placeholder) placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        function handleTypeChange() {
            const purpose = document.getElementById('purpose')?.value;
            const dateGrid = document.getElementById('dateGrid');
            const periodOther = document.getElementById('periodOther');
            const label = document.getElementById('periodLabel');
            if(!dateGrid || !periodOther) return;
            if (purpose === "·àå·àã ·ä≠·çç·ã´") {
                dateGrid.classList.add('hidden');
                periodOther.classList.remove('hidden');
                if(label) label.innerText = "·ã®·ä≠·çç·ã´ ·ãì·àã·àõ (Purpose)";
            } else {
                dateGrid.classList.remove('hidden');
                periodOther.classList.add('hidden');
                if(label) label.innerText = "·ã®·ä≠·çç·ã´ ·åä·ãú";
            }
        }

        function autoCalculatePenalty() {
            const purpose = document.getElementById('purpose')?.value;
            const day = parseInt(document.getElementById('periodDay')?.value || "1");
            let p = 0; let note = "";
            if (purpose === "·àò·ã∞·â†·äõ ·àò·ãã·åÆ") {
                if (day >= 6 && day <= 10) { p = 20; note = "·ã®·âÄ·äï 6-10 ·âÖ·å£·âµ (20 ·â•·à≠)"; }
                else if (day >= 11) { p = 50; note = "·ä®·âÄ·äï 11 ·â†·äã·àã ·âÖ·å£·âµ (50 ·â•·à≠)"; }
            }
            if(document.getElementById('penalty')) document.getElementById('penalty').value = p;
            if(document.getElementById('penaltyHint')) document.getElementById('penaltyHint').innerText = note;
        }

        document.getElementById('paymentForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const purpose = document.getElementById('purpose')?.value;
            let finalPeriod = (purpose === "·àå·àã ·ä≠·çç·ã´") ? 
                document.getElementById('periodOther')?.value : 
                `${document.getElementById('periodMonth')?.value} ${document.getElementById('periodDay')?.value}, ${document.getElementById('periodYear')?.value}`;

            const payload = {
                type: 'payment_report',
                gateway: (payMode === 'manual') ? 'manual' : digitalGateway,
                purpose: purpose,
                period: finalPeriod,
                amount: document.getElementById('amount')?.value,
                penalty: document.getElementById('penalty')?.value,
                payFor: payerMode === 'self' ? 'self' : document.getElementById('targetMember')?.value
            };
            tg.sendData(JSON.stringify(payload));
            tg.close();
        });

        populateDateSelectors();
        handleTypeChange();
        if(tg.initDataUnsafe?.user) {
            document.getElementById('userFullName').innerText = `·à∞·àã·àù ${tg.initDataUnsafe.user.first_name}!`;
        }
    </script>
</body>
</html>
